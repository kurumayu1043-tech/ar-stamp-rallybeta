<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="ARã‚¹ã‚¿ãƒ³ãƒ—">
    <title>æ–‡åŒ–ç¥­ ARã‚¹ã‚¿ãƒ³ãƒ—ãƒ©ãƒªãƒ¼</title>
    
    <!-- iOSç”¨ã‚¢ã‚¤ã‚³ãƒ³ -->
    <link rel="apple-touch-icon" href="nisyama1.png">
    
    <!-- PWAå¯¾å¿œã®ãŸã‚ã®ãƒãƒ‹ãƒ•ã‚§ã‚¹ãƒˆ -->
    <link rel="manifest" href="manifest.json">
    
    <!-- A-Frameãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’CDNã‹ã‚‰èª­ã¿è¾¼ã¿ -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <style>
        /* Base styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            overflow: hidden;
            height: 100vh;
            height: -webkit-fill-available;
            -webkit-user-select: none;
            user-select: none;
            touch-action: none;
        }

        #app {
            position: relative;
            width: 100%;
            height: 100vh;
            height: -webkit-fill-available;
        }

        /* ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ */
        #start-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
            padding-top: env(safe-area-inset-top);
            padding-bottom: env(safe-area-inset-bottom);
            transition: opacity 0.5s ease-in-out;
            z-index: 10;
        }

        #start-screen h1 {
            font-size: 2.5rem;
            margin-bottom: 20px;
        }

        #start-screen p {
            font-size: 1.1rem;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .cta-button {
            padding: 12px 24px;
            font-size: 1.2rem;
            border: none;
            border-radius: 50px;
            background-color: #ff5e62;
            color: white;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s, background-color 0.2s;
            -webkit-appearance: none;
            appearance: none;
        }

        .cta-button:active {
            transform: scale(0.95);
            background-color: #ff4a4e;
        }

        /* ã‚¹ã‚¿ãƒ³ãƒ—ä¸€è¦§ç”»é¢ */
        #stamp-screen {
            display: none;
            padding: 20px;
            padding-top: calc(20px + env(safe-area-inset-top));
            padding-bottom: calc(20px + env(safe-area-inset-bottom));
            color: white;
            text-align: center;
            z-index: 8;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        #stamp-screen h2 {
            font-size: 2rem;
            margin-bottom: 20px;
        }

        .stamp-count {
            font-size: 1.2rem;
            margin-bottom: 20px;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            display: inline-block;
        }

        .stamp-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 20px;
            justify-content: center;
            max-width: 700px;
            margin: 0 auto 30px;
        }

        .stamp-item {
            padding: 15px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            opacity: 0.5;
            transition: all 0.5s ease-in-out;
            cursor: pointer;
        }
        
        .stamp-item.collected {
            opacity: 1;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
            animation: bounce 0.5s;
        }

        @keyframes bounce {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .stamp-item img {
            width: 100%;
            height: auto;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .stamp-item p {
            font-size: 0.9rem;
            font-weight: bold;
        }

        .stamp-item small {
            display: block;
            margin-top: 5px;
            font-size: 0.8rem;
            opacity: 0.8;
        }
        
        /* æˆ»ã‚‹ãƒœã‚¿ãƒ³ */
        #back-button, #ar-back-button {
            position: fixed;
            top: calc(15px + env(safe-area-inset-top));
            left: 15px;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 1.5rem;
            display: none;
            cursor: pointer;
            z-index: 201;
            transition: background-color 0.2s;
            -webkit-appearance: none;
            appearance: none;
        }
        
        #back-button:active, #ar-back-button:active {
            background-color: rgba(0, 0, 0, 0.7);
        }

        /* ã‚«ãƒ¡ãƒ©ãƒ“ãƒ¥ãƒ¼ */
        #camera-view {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            z-index: 5;
            background-color: black;
        }

        #camera-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #camera-permission-msg {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 20px 30px;
            border-radius: 20px;
            text-align: center;
            z-index: 6;
            display: none;
        }

        .camera-permission-button {
            margin-top: 15px;
            padding: 10px 20px;
            background-color: #ff5e62;
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 1rem;
            cursor: pointer;
            -webkit-appearance: none;
            appearance: none;
        }

        /* ARè¡¨ç¤ºç”¨ */
        #ar-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            z-index: 100;
        }

        #ar-scene {
            position: fixed !important;
            top: 0;
            left: 0;
            width: 100% !important;
            height: 100% !important;
            z-index: 101;
        }

        /* ARæƒ…å ±ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
        .ar-overlay {
            position: fixed;
            top: calc(60px + env(safe-area-inset-top));
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 15px 30px;
            border-radius: 25px;
            z-index: 200;
            text-align: center;
            display: none;
        }

        .ar-overlay h3 {
            font-size: 1.3rem;
            margin-bottom: 5px;
        }

        .ar-overlay p {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* ã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆç”»é¢ */
        .complete-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #333;
            padding: 30px 50px;
            border-radius: 20px;
            font-size: 1.8rem;
            font-weight: bold;
            z-index: 300;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            animation: completeAnimation 3s ease-in-out;
            text-align: center;
        }

        @keyframes completeAnimation {
            0% { 
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.5) rotate(-10deg);
            }
            50% { 
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.1) rotate(5deg);
            }
            100% { 
                opacity: 1;
                transform: translate(-50%, -50%) scale(1) rotate(0deg);
            }
        }
        
        /* ãƒ­ã‚°ã‚³ãƒ³ã‚½ãƒ¼ãƒ« */
        #log-console {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            max-height: 150px;
            background-color: rgba(0, 0, 0, 0.7);
            color: #00ff00;
            font-family: 'Courier New', monospace;
            padding: 10px;
            overflow-y: scroll;
            display: none; /* ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§éè¡¨ç¤º */
            z-index: 10;
        }

        /* ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ */
        .reset-button {
            background-color: #666;
            font-size: 0.9rem;
            padding: 8px 16px;
            margin-top: 20px;
        }

        .reset-button:active {
            background-color: #555;
        }

        /* iOSç”¨ã®ãƒ›ãƒ¼ãƒ ç”»é¢è¿½åŠ ãƒœã‚¿ãƒ³ */
        #ios-install-button {
            display: none;
            background-color: #4CAF50;
            margin-top: 20px;
            font-size: 1rem;
        }

        #ios-install-button:active {
            background-color: #45a049;
        }

        /* iOS Safariæ¤œå‡ºãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
        .ios-install-message {
            background: rgba(255, 255, 255, 0.1);
            padding: 15px;
            border-radius: 15px;
            margin-top: 20px;
            font-size: 0.9rem;
            display: none;
        }

        .ios-install-message.show {
            display: block;
        }

        @media screen and (max-width: 768px) {
            #start-screen h1 {
                font-size: 2rem;
            }
            
            .stamp-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ -->
        <div id="start-screen">
            <h1>æ–‡åŒ–ç¥­ ARã‚¹ã‚¿ãƒ³ãƒ—ãƒ©ãƒªãƒ¼</h1>
            <p>
                8ã¤ã®å ´æ‰€ã§QRã‚³ãƒ¼ãƒ‰ã‚’è¦‹ã¤ã‘ã¦<br>
                ã‚¹ãƒãƒ›ã®ã‚«ãƒ¡ãƒ©ã§èª­ã¿å–ã‚ã†ï¼<br>
                å…¨éƒ¨é›†ã‚ã‚‹ã¨ç´ æ•µãªã“ã¨ãŒ...ï¼Ÿ
            </p>
            <button id="stamps-button" class="cta-button">ã‚¹ã‚¿ãƒ³ãƒ—ä¸€è¦§ã‚’è¦‹ã‚‹</button>
            
            <div class="ios-install-message" id="ios-install-message">
                <p>ğŸ“± ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ ã™ã‚‹ã¨ä¾¿åˆ©ã§ã™</p>
                <p style="font-size: 0.8rem; margin-top: 5px;">
                    ä¸‹ã®å…±æœ‰ãƒœã‚¿ãƒ³ â†’ ãƒ›ãƒ¼ãƒ ç”»é¢ã«è¿½åŠ 
                </p>
            </div>
            
            <p style="margin-top: 20px; font-size: 0.9rem; opacity: 0.8;">
                QRã‚³ãƒ¼ãƒ‰ã¯ã‚¹ãƒãƒ›ã®ã‚«ãƒ¡ãƒ©ã‚¢ãƒ—ãƒªã§<br>
                èª­ã¿å–ã£ã¦ãã ã•ã„
            </p>
        </div>

        <!-- ã‚¹ã‚¿ãƒ³ãƒ—ä¸€è¦§ç”»é¢ -->
        <div id="stamp-screen">
            <h2>é›†ã‚ãŸã‚¹ã‚¿ãƒ³ãƒ—</h2>
            <div class="stamp-count" id="stamp-count">0 / 8 å€‹ç²å¾—</div>
            <div class="stamp-grid" id="stamp-grid">
                <!-- JavaScriptã§ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ç”Ÿæˆ -->
            </div>
            <p>
                <button id="show-start-button" class="cta-button">ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</button>
                <br>
                <button id="reset-stamps-button" class="cta-button reset-button">ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ãƒªã‚»ãƒƒãƒˆ</button>
            </p>
        </div>

        <!-- ã‚«ãƒ¡ãƒ©ãƒ“ãƒ¥ãƒ¼ï¼ˆARèƒŒæ™¯ç”¨ï¼‰ -->
        <div id="camera-view">
            <video id="camera-video" autoplay playsinline muted></video>
            <div id="camera-permission-msg">
                <p>ğŸ“¸ ã‚«ãƒ¡ãƒ©ã‚’ä½¿ç”¨ã—ã¦ARè¡¨ç¤ºã—ã¾ã™</p>
                <button class="camera-permission-button" id="start-camera-button">ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•</button>
                <p style="font-size: 0.8rem; margin-top: 10px; opacity: 0.8;">
                    iOSã®å ´åˆã¯è¨­å®šã§ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ã‚’<br>
                    è¨±å¯ã—ã¦ãã ã•ã„
                </p>
            </div>
        </div>

        <!-- ARè¡¨ç¤ºç”»é¢ -->
        <div id="ar-screen">
            <!-- ARæƒ…å ±ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ -->
            <div class="ar-overlay" id="ar-overlay">
                <h3 id="ar-location-name">å ´æ‰€å</h3>
                <p id="ar-location-desc">èª¬æ˜</p>
            </div>
        </div>
    </div>
    
    <!-- 2Dç”»åƒã‚’è¡¨ç¤ºã™ã‚‹A-Frameã‚·ãƒ¼ãƒ³ -->
    <a-scene id="ar-scene" embedded vr-mode-ui="enabled: false" device-orientation-permission-ui="enabled: false">
        <a-assets>
            <!-- ãƒã‚¹ã‚³ãƒƒãƒˆã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã®ç”»åƒ (nisyama1.png) -->
            <img id="mascot-image" src="./nisyama1.png" crossorigin="anonymous">
        </a-assets>

        <!-- 2Dç”»åƒã‚’ã‚«ãƒ¡ãƒ©ã®å‰ã«é…ç½®ï¼ˆãƒ“ãƒ«ãƒœãƒ¼ãƒ‰åŠ¹æœã§å¸¸ã«ã‚«ãƒ¡ãƒ©ã®æ–¹ã‚’å‘ãï¼‰ -->
        <a-image 
            id="mascot-ar-image"
            src="#mascot-image" 
            position="0 0 -3" 
            scale="3 3 1" 
            look-at="[camera]"
            transparent="true"
            animation__position="property: position; from: 0 -1 -3; to: 0 0.5 -3; dur: 2000; easing: easeInOutSine; loop: true; dir: alternate"
            animation__rotation="property: rotation; from: 0 0 -10; to: 0 0 10; dur: 4000; easing: easeInOutSine; loop: true; dir: alternate"
            animation__scale="property: scale; from: 3 3 1; to: 3.5 3.5 1; dur: 1500; easing: easeInOutSine; loop: true; dir: alternate">
        </a-image>

        <!-- A-Frameã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚«ãƒ¡ãƒ©ã‚’ä½¿ç”¨ -->
        <a-camera></a-camera>
    </a-scene>
    
    <!-- æˆ»ã‚‹ãƒœã‚¿ãƒ³ -->
    <button id="back-button" aria-label="æˆ»ã‚‹" style="display: none;">&#8592;</button>
    <button id="ar-back-button" aria-label="æˆ»ã‚‹" style="display: none;">&#8592;</button>
    
    <!-- ãƒ­ã‚°ã‚³ãƒ³ã‚½ãƒ¼ãƒ« -->
    <pre id="log-console"></pre>

    <script>
        /**
         * ãƒ‡ãƒãƒƒã‚°ç”¨ãƒ­ã‚°å‡ºåŠ›é–¢æ•°
         * @param {string} message - ãƒ­ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
         */
        const logConsole = document.getElementById('log-console');
        function log(message) {
            console.log(message);
            const line = document.createElement('div');
            line.textContent = message;
            logConsole.appendChild(line);
            logConsole.scrollTop = logConsole.scrollHeight;
        }

        // iOS Safariæ¤œå‡º
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
        const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
        const isStandalone = window.navigator.standalone || window.matchMedia('(display-mode: standalone)').matches;

        // Service Workerç™»éŒ²
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js')
                .then(reg => log('Service Worker registered'))
                .catch(err => log('Service Worker registration failed: ' + err));
        }

        const app = {
            currentScreen: 'start',
            cameraStream: null,
            isIOS: isIOS,
            isSafari: isSafari,
            pendingStamp: null, // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰å–å¾—ã—ãŸã‚¹ã‚¿ãƒ³ãƒ—ã‚’ä¸€æ™‚ä¿æŒ
            stamps: {
                entrance: { 
                    name: 'å…¥å ´å£', 
                    collected: false, 
                    img: 'https://placehold.co/150x150/ffc0cb/000?text=å…¥å ´å£',
                    description: 'ã‚ˆã†ã“ãæ–‡åŒ–ç¥­ã¸ï¼'
                },
                ticket: { 
                    name: 'é‡‘åˆ¸å£²ã‚Šå ´', 
                    collected: false, 
                    img: 'https://placehold.co/150x150/98c1d9/000?text=é‡‘åˆ¸',
                    description: 'é‡‘åˆ¸ã¯ã“ã¡ã‚‰ã§'
                },
                stage: { 
                    name: 'ã‚¹ãƒ†ãƒ¼ã‚¸å‰', 
                    collected: false, 
                    img: 'https://placehold.co/150x150/f7e07a/000?text=ã‚¹ãƒ†ãƒ¼ã‚¸',
                    description: 'ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’æ¥½ã—ã‚‚ã†'
                },
                bunmi1: { 
                    name: 'æ–‡å®Ÿæ¨¡æ“¬åº—ï¼‘', 
                    collected: false, 
                    img: 'https://placehold.co/150x150/a9e2a9/000?text=æ–‡å®Ÿ1',
                    description: 'ç¾å‘³ã—ã„é£Ÿã¹ç‰©ãŒã„ã£ã±ã„'
                },
                bunmi2: { 
                    name: 'æ–‡å®Ÿæ¨¡æ“¬åº—ï¼’', 
                    collected: false, 
                    img: 'https://placehold.co/150x150/d2b4de/000?text=æ–‡å®Ÿ2',
                    description: 'æ¥½ã—ã„ã‚²ãƒ¼ãƒ ã‚³ãƒ¼ãƒŠãƒ¼'
                },
                yamato: { 
                    name: 'åº­å¤§å’Œ', 
                    collected: false, 
                    img: 'https://placehold.co/150x150/ffb6c1/000?text=åº­å¤§å’Œ',
                    description: 'æ†©ã„ã®ç©ºé–“'
                },
                rhythm: { 
                    name: 'ãƒªã‚ºãƒ é¤¨', 
                    collected: false, 
                    img: 'https://placehold.co/150x150/87ceeb/000?text=ãƒªã‚ºãƒ é¤¨',
                    description: 'éŸ³æ¥½ã®ä¸–ç•Œã¸'
                },
                gym: { 
                    name: 'ä½“è‚²é¤¨', 
                    collected: false, 
                    img: 'https://placehold.co/150x150/dda0dd/000?text=ä½“è‚²é¤¨',
                    description: 'ã‚¹ãƒãƒ¼ãƒ„ã‚¤ãƒ™ãƒ³ãƒˆé–‹å‚¬ä¸­'
                }
            },
            
            log: log,

            /**
             * ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆæœŸåŒ–
             */
            init() {
                // æœ€åˆã«localStorageã‹ã‚‰ã‚¹ã‚¿ãƒ³ãƒ—ã‚’èª­ã¿è¾¼ã¿
                this.loadStamps();
                
                // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ãƒã‚§ãƒƒã‚¯ã—ã¦å‡¦ç†ï¼ˆindex.htmlã«ã¯é€šå¸¸stamp paramaeterãŒæ¥ãªã„ã¯ãšï¼‰
                this.processUrlParams();
                
                // localStorageã‹ã‚‰ãƒšãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ãƒã‚§ãƒƒã‚¯ï¼ˆæ—§stamp.htmlã¨ã®äº’æ›æ€§ï¼‰
                this.checkPendingStamps();
                
                // ãã®ä»–ã®åˆæœŸåŒ–å‡¦ç†
                this.setupEventListeners();
                this.setupIOSInstall();
                this.renderStamps();
                this.updateStampCount();
                
                // ãƒšãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ã‚¿ãƒ³ãƒ—ãŒã‚ã‚Œã°ARè¡¨ç¤ºã€ãªã‘ã‚Œã°ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢
                if (this.pendingStamp) {
                    this.showScreen('ar');
                } else {
                    this.showScreen('start');
                }
                
                log(`AR Stamp Rally initialized - iOS: ${isIOS}, Safari: ${isSafari}, Standalone: ${isStandalone}`);
            },

            /**
             * localStorageã‹ã‚‰ãƒšãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ãƒã‚§ãƒƒã‚¯
             */
            checkPendingStamps() {
                try {
                    // stamp.htmlã‹ã‚‰æ¸¡ã•ã‚ŒãŸã‚¹ã‚¿ãƒ³ãƒ—ã‚’ãƒã‚§ãƒƒã‚¯
                    const pendingStamps = JSON.parse(localStorage.getItem('pendingStamps') || '[]');
                    const lastStamp = localStorage.getItem('lastStamp');
                    const timestamp = localStorage.getItem('stampTimestamp');
                    
                    if (pendingStamps.length > 0) {
                        // æœ€æ–°ã®ã‚¹ã‚¿ãƒ³ãƒ—ã‚’å‡¦ç†
                        const stampToProcess = lastStamp || pendingStamps[pendingStamps.length - 1];
                        
                        // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãƒã‚§ãƒƒã‚¯ï¼ˆ5ç§’ä»¥å†…ãªã‚‰æ–°ã—ã„ã‚¹ã‚¿ãƒ³ãƒ—ã¨ã¿ãªã™ï¼‰
                        const now = Date.now();
                        const stampTime = parseInt(timestamp || '0');
                        const isRecent = (now - stampTime) < 5000;
                        
                        if (this.stamps[stampToProcess]) {
                            log(`ãƒšãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ã‚¿ãƒ³ãƒ—æ¤œå‡º: ${stampToProcess} (Recent: ${isRecent})`);
                            
                            // ã‚¹ã‚¿ãƒ³ãƒ—ã‚’åé›†
                            if (!this.stamps[stampToProcess].collected || isRecent) {
                                this.stamps[stampToProcess].collected = true;
                                this.pendingStamp = stampToProcess;
                                log(`ã‚¹ã‚¿ãƒ³ãƒ—ç²å¾—: ${this.stamps[stampToProcess].name}`);
                            }
                            
                            // å‡¦ç†æ¸ˆã¿ã®ã‚¹ã‚¿ãƒ³ãƒ—ã‚’å‰Šé™¤
                            const remainingStamps = pendingStamps.filter(s => s !== stampToProcess);
                            if (remainingStamps.length > 0) {
                                localStorage.setItem('pendingStamps', JSON.stringify(remainingStamps));
                            } else {
                                localStorage.removeItem('pendingStamps');
                            }
                            localStorage.removeItem('lastStamp');
                            localStorage.removeItem('stampTimestamp');
                        }
                    }
                } catch (e) {
                    log('localStorage pendingStamps check error: ' + e);
                }
            },

            /**
             * URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å‡¦ç†ã—ã¦ã‚¯ãƒªãƒ¼ãƒ³ãªURLã«æ›¸ãæ›ãˆ
             */
            processUrlParams() {
                const urlParams = new URLSearchParams(window.location.search);
                const stampParam = urlParams.get('stamp');
                
                if (stampParam) {
                    // index.htmlã§stampãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å—ã‘å–ã£ãŸã‚‰collect.htmlã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
                    log(`index.htmlã«stampãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æ¤œå‡º: ${stampParam} -> collect.htmlã«è»¢é€`);
                    window.location.replace(`collect.html?stamp=${encodeURIComponent(stampParam)}`);
                    return;
                }
                
                // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ãƒšãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ã‚¿ãƒ³ãƒ—ã‚’å¾©å…ƒ
                const pendingStamp = sessionStorage.getItem('pendingStamp');
                if (pendingStamp && this.stamps[pendingStamp]) {
                    this.pendingStamp = pendingStamp;
                    log(`ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‹ã‚‰ã‚¹ã‚¿ãƒ³ãƒ—å¾©å…ƒ: ${pendingStamp}`);
                }
            },

            /**
             * iOSå‘ã‘ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ¡ˆå†…
             */
            setupIOSInstall() {
                if (isIOS && !isStandalone) {
                    const installMsg = document.getElementById('ios-install-message');
                    if (installMsg) {
                        installMsg.classList.add('show');
                    }
                }
            },

            /**
             * ã‚«ãƒ¡ãƒ©ã‚’èµ·å‹•ï¼ˆiOSå¯¾å¿œç‰ˆï¼‰
             */
            async startCamera() {
                const video = document.getElementById('camera-video');
                const permissionMsg = document.getElementById('camera-permission-msg');
                const startButton = document.getElementById('start-camera-button');
                
                // iOSã®å ´åˆã€ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œãŒå¿…è¦
                if (this.isIOS && !this.cameraStream) {
                    permissionMsg.style.display = 'block';
                    
                    // ãƒœã‚¿ãƒ³ã‚¯ãƒªãƒƒã‚¯ã§ã‚«ãƒ¡ãƒ©èµ·å‹•
                    const startCameraHandler = async () => {
                        startButton.removeEventListener('click', startCameraHandler);
                        await this.requestCamera();
                    };
                    
                    startButton.addEventListener('click', startCameraHandler);
                } else {
                    await this.requestCamera();
                }
            },

            /**
             * ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ã‚’ãƒªã‚¯ã‚¨ã‚¹ãƒˆ
             */
            async requestCamera() {
                const video = document.getElementById('camera-video');
                const permissionMsg = document.getElementById('camera-permission-msg');
                
                try {
                    const constraints = {
                        video: { 
                            facingMode: { ideal: 'environment' },
                            width: { ideal: 1920 },
                            height: { ideal: 1080 }
                        },
                        audio: false
                    };
                    
                    // iOSã®å ´åˆã¯ç‰¹åˆ¥ãªå‡¦ç†
                    if (this.isIOS) {
                        constraints.video = {
                            facingMode: 'environment'
                        };
                    }
                    
                    this.cameraStream = await navigator.mediaDevices.getUserMedia(constraints);
                    video.srcObject = this.cameraStream;
                    
                    // iOSã§ã®å†ç”Ÿã‚’ç¢ºå®Ÿã«ã™ã‚‹
                    video.setAttribute('autoplay', '');
                    video.setAttribute('playsinline', '');
                    video.setAttribute('muted', '');
                    
                    await video.play();
                    
                    permissionMsg.style.display = 'none';
                    log('Camera started successfully');
                } catch (err) {
                    log(`Camera error: ${err.message}`);
                    
                    // ãƒ•ãƒ­ãƒ³ãƒˆã‚«ãƒ¡ãƒ©ã§å†è©¦è¡Œ
                    try {
                        const fallbackConstraints = {
                            video: { 
                                facingMode: 'user'
                            },
                            audio: false
                        };
                        
                        this.cameraStream = await navigator.mediaDevices.getUserMedia(fallbackConstraints);
                        video.srcObject = this.cameraStream;
                        
                        video.setAttribute('autoplay', '');
                        video.setAttribute('playsinline', '');
                        video.setAttribute('muted', '');
                        
                        await video.play();
                        
                        permissionMsg.style.display = 'none';
                        log('Using front camera as fallback');
                    } catch (fallbackErr) {
                        permissionMsg.innerHTML = `
                            <p>ğŸ“µ ã‚«ãƒ¡ãƒ©ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ</p>
                            <p style="font-size: 0.8rem; margin-top: 10px;">
                                è¨­å®šã‚¢ãƒ—ãƒª â†’ Safari â†’ ã‚«ãƒ¡ãƒ©<br>
                                ã§ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã—ã¦ãã ã•ã„
                            </p>
                            <button class="camera-permission-button" onclick="location.reload()">
                                å†èª­ã¿è¾¼ã¿
                            </button>
                        `;
                        log(`Camera access denied: ${fallbackErr.message}`);
                    }
                }
            },

            /**
             * ã‚«ãƒ¡ãƒ©ã‚’åœæ­¢
             */
            stopCamera() {
                if (this.cameraStream) {
                    this.cameraStream.getTracks().forEach(track => {
                        track.stop();
                    });
                    this.cameraStream = null;
                    const video = document.getElementById('camera-video');
                    if (video) {
                        video.srcObject = null;
                    }
                    log('Camera stopped');
                }
            },

            /**
             * localStorageã‹ã‚‰ã‚¹ã‚¿ãƒ³ãƒ—ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ­ãƒ¼ãƒ‰
             */
            loadStamps() {
                try {
                    const savedStamps = localStorage.getItem('arStamps2024');
                    if (savedStamps) {
                        const parsedStamps = JSON.parse(savedStamps);
                        let loadedCount = 0;
                        Object.keys(this.stamps).forEach(key => {
                            if (parsedStamps[key] && parsedStamps[key].collected) {
                                this.stamps[key].collected = true;
                                loadedCount++;
                            }
                        });
                        log(`ã‚¹ã‚¿ãƒ³ãƒ—ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸ: ${loadedCount}å€‹ã®ã‚¹ã‚¿ãƒ³ãƒ—`);
                    } else {
                        log('ä¿å­˜ã•ã‚ŒãŸã‚¹ã‚¿ãƒ³ãƒ—ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                    }
                } catch (e) {
                    log('localStorageåˆ©ç”¨ä¸å¯ã€ãƒ¡ãƒ¢ãƒªå†…ã§ç®¡ç†ã—ã¾ã™: ' + e.message);
                }
            },

            /**
             * localStorageã«ã‚¹ã‚¿ãƒ³ãƒ—ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
             */
            saveStamps() {
                try {
                    // collect.htmlã¨åŒã˜å½¢å¼ã§ä¿å­˜
                    const saveData = {};
                    Object.keys(this.stamps).forEach(key => {
                        if (this.stamps[key].collected) {
                            saveData[key] = { collected: true };
                        }
                    });
                    localStorage.setItem('arStamps2024', JSON.stringify(saveData));
                    log('ã‚¹ã‚¿ãƒ³ãƒ—ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸ');
                } catch (e) {
                    log('localStorageåˆ©ç”¨ä¸å¯');
                }
            },

            /**
             * ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ãƒªã‚»ãƒƒãƒˆ
             */
            resetStamps() {
                if (confirm('æœ¬å½“ã«ã™ã¹ã¦ã®ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                    Object.keys(this.stamps).forEach(key => {
                        this.stamps[key].collected = false;
                    });
                    this.saveStamps();
                    this.renderStamps();
                    this.updateStampCount();
                    log('ã™ã¹ã¦ã®ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
                    
                    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚‚ã‚¯ãƒªã‚¢
                    sessionStorage.removeItem('pendingStamp');
                    this.pendingStamp = null;
                }
            },

            /**
             * ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
             */
            setupEventListeners() {
                document.getElementById('stamps-button').addEventListener('click', () => this.showScreen('stamps'));
                document.getElementById('back-button').addEventListener('click', () => this.showScreen('start'));
                document.getElementById('ar-back-button').addEventListener('click', () => {
                    this.stopAR();
                    // ãƒšãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ã‚¯ãƒªã‚¢
                    sessionStorage.removeItem('pendingStamp');
                    this.pendingStamp = null;
                    this.showScreen('stamps');
                });
                document.getElementById('show-start-button').addEventListener('click', () => this.showScreen('start'));
                document.getElementById('reset-stamps-button').addEventListener('click', () => this.resetStamps());
                
                // iOSå‘ã‘ã®ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆæœ€é©åŒ–
                if (this.isIOS) {
                    document.addEventListener('touchstart', function() {}, {passive: true});
                }
            },

            /**
             * ç”»é¢åˆ‡ã‚Šæ›¿ãˆ
             * @param {string} screenId - åˆ‡ã‚Šæ›¿ãˆã‚‹ç”»é¢ID ('start', 'stamps', 'ar')
             */
            showScreen(screenId) {
                this.currentScreen = screenId;
                
                const startScreen = document.getElementById('start-screen');
                const stampScreen = document.getElementById('stamp-screen');
                const arScreen = document.getElementById('ar-screen');
                const arScene = document.getElementById('ar-scene');
                const cameraView = document.getElementById('camera-view');
                const backButton = document.getElementById('back-button');
                const arBackButton = document.getElementById('ar-back-button');
                const arOverlay = document.getElementById('ar-overlay');
                
                // å…¨ã¦ã®ç”»é¢ã‚’éè¡¨ç¤ºã«
                startScreen.style.display = 'none';
                stampScreen.style.display = 'none';
                arScreen.style.display = 'none';
                arScene.style.display = 'none';
                cameraView.style.display = 'none';
                backButton.style.display = 'none';
                arBackButton.style.display = 'none';
                arOverlay.style.display = 'none';

                if (screenId === 'start') {
                    startScreen.style.display = 'flex';
                    this.stopCamera();
                    this.stopAR();
                    log('ã‚¹ã‚¿ãƒ¼ãƒˆç”»é¢ã‚’è¡¨ç¤º');
                } else if (screenId === 'stamps') {
                    stampScreen.style.display = 'block';
                    backButton.style.display = 'block';
                    this.renderStamps();
                    this.updateStampCount();
                    this.stopCamera();
                    this.stopAR();
                    // ã‚¹ã‚¿ãƒ³ãƒ—ä¿å­˜
                    this.saveStamps();
                    log('ã‚¹ã‚¿ãƒ³ãƒ—ä¸€è¦§ç”»é¢ã‚’è¡¨ç¤º');
                } else if (screenId === 'ar') {
                    // ãƒšãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ã‚¿ãƒ³ãƒ—ãŒãªã„å ´åˆã¯ä½•ã‚‚ã—ãªã„
                    if (!this.pendingStamp) {
                        log('è¡¨ç¤ºã™ã‚‹ã‚¹ã‚¿ãƒ³ãƒ—ãŒã‚ã‚Šã¾ã›ã‚“');
                        this.showScreen('start');
                        return;
                    }
                    
                    // ã‚«ãƒ¡ãƒ©ãƒ“ãƒ¥ãƒ¼ã‚’è¡¨ç¤ºï¼ˆèƒŒæ™¯ã¨ã—ã¦ï¼‰
                    cameraView.style.display = 'block';
                    this.startCamera();
                    
                    // ARè¦ç´ ã‚’è¡¨ç¤º
                    arScreen.style.display = 'block';
                    arScene.style.display = 'block';
                    arBackButton.style.display = 'block';
                    arOverlay.style.display = 'block';
                    
                    // å ´æ‰€æƒ…å ±ã‚’è¡¨ç¤º
                    if (this.pendingStamp && this.stamps[this.pendingStamp]) {
                        document.getElementById('ar-location-name').textContent = this.stamps[this.pendingStamp].name;
                        document.getElementById('ar-location-desc').textContent = this.stamps[this.pendingStamp].description;
                    }
                    
                    // ARã‚·ãƒ¼ãƒ³ã‚’å†ç”Ÿ
                    if (arScene.play && typeof arScene.play === 'function') {
                        try {
                            arScene.play();
                        } catch (e) {
                            log('AR scene play error: ' + e.message);
                        }
                    }
                    
                    // ã‚¹ã‚¿ãƒ³ãƒ—ç²å¾—ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’è¡¨ç¤º
                    this.showStampEffect();
                    
                    log('ARç”»é¢ã‚’è¡¨ç¤ºï¼ˆã‚«ãƒ¡ãƒ©èƒŒæ™¯ä»˜ãï¼‰');
                }
            },
            
            /**
             * ARã‚·ãƒ¼ãƒ³ã‚’åœæ­¢
             */
            stopAR() {
                const arScene = document.getElementById('ar-scene');
                if (arScene) {
                    try {
                        if (arScene.pause && typeof arScene.pause === 'function') {
                            arScene.pause();
                        }
                    } catch (e) {
                        log('AR scene pause not supported');
                    }
                    arScene.style.display = 'none';
                    
                    // ARã‚¤ãƒ¡ãƒ¼ã‚¸ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ãƒªã‚»ãƒƒãƒˆ
                    const mascotImage = document.getElementById('mascot-ar-image');
                    if (mascotImage) {
                        mascotImage.setAttribute('position', '0 0 -3');
                        mascotImage.setAttribute('scale', '3 3 1');
                        mascotImage.setAttribute('rotation', '0 0 0');
                    }
                    
                    // ã‚«ãƒ¡ãƒ©ã‚‚åœæ­¢
                    this.stopCamera();
                    
                    log('ARã‚·ãƒ¼ãƒ³ã‚’åœæ­¢');
                }
            },

            /**
             * ã‚¹ã‚¿ãƒ³ãƒ—ã‚’åé›†ã—ã€ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
             * @param {string} stampType - åé›†ã™ã‚‹ã‚¹ã‚¿ãƒ³ãƒ—ã®ã‚¿ã‚¤ãƒ—
             */
            collectStamp(stampType) {
                if (this.stamps[stampType]) {
                    this.stamps[stampType].collected = true;
                    this.saveStamps();
                    this.renderStamps();
                    this.updateStampCount();
                    
                    // å…¨ã‚¹ã‚¿ãƒ³ãƒ—ç²å¾—ãƒã‚§ãƒƒã‚¯
                    this.checkAllStampsCollected();
                }
            },

            /**
             * ã‚¹ã‚¿ãƒ³ãƒ—ç²å¾—æ•°ã‚’æ›´æ–°
             */
            updateStampCount() {
                const collectedCount = Object.values(this.stamps).filter(s => s.collected).length;
                const totalCount = Object.keys(this.stamps).length;
                const countElement = document.getElementById('stamp-count');
                if (countElement) {
                    countElement.textContent = `${collectedCount} / ${totalCount} å€‹ç²å¾—`;
                    
                    // å…¨éƒ¨é›†ã‚ãŸã‚‰ç‰¹åˆ¥ãªè¡¨ç¤º
                    if (collectedCount === totalCount) {
                        countElement.style.background = 'linear-gradient(135deg, #ffd700, #ffed4e)';
                        countElement.style.color = '#333';
                    }
                }
            },

            /**
             * å…¨ã‚¹ã‚¿ãƒ³ãƒ—åé›†ã‚’ãƒã‚§ãƒƒã‚¯
             */
            checkAllStampsCollected() {
                const allCollected = Object.values(this.stamps).every(s => s.collected);
                if (allCollected) {
                    log('ğŸ‰ å…¨ã‚¹ã‚¿ãƒ³ãƒ—ã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆï¼');
                    setTimeout(() => {
                        this.showCompleteMessage();
                    }, 2000);
                }
            },

            /**
             * ã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
             */
            showCompleteMessage() {
                const completeDiv = document.createElement('div');
                completeDiv.className = 'complete-message';
                completeDiv.innerHTML = `
                    <div>ğŸŠ ã‚³ãƒ³ãƒ—ãƒªãƒ¼ãƒˆï¼ ğŸŠ</div>
                    <div style="font-size: 1.2rem; margin-top: 10px;">
                        å…¨ã‚¹ã‚¿ãƒ³ãƒ—ç²å¾—ãŠã‚ã§ã¨ã†ï¼
                    </div>
                    <div style="font-size: 1rem; margin-top: 10px;">
                        ç´ æ™´ã‚‰ã—ã„æ¢æ¤œã§ã—ãŸï¼
                    </div>
                `;
                document.body.appendChild(completeDiv);
                
                setTimeout(() => {
                    completeDiv.remove();
                }, 5000);
            },

            /**
             * ã‚¹ã‚¿ãƒ³ãƒ—ç²å¾—ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’è¡¨ç¤º
             */
            showStampEffect() {
                let stampName = 'ã‚¹ã‚¿ãƒ³ãƒ—';
                
                if (this.pendingStamp && this.stamps[this.pendingStamp]) {
                    stampName = this.stamps[this.pendingStamp].name;
                }
                
                // ã‚¹ã‚¿ãƒ³ãƒ—ç²å¾—ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
                const effectDiv = document.createElement('div');
                effectDiv.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: rgba(255, 255, 255, 0.95);
                    padding: 20px 40px;
                    border-radius: 20px;
                    font-size: 1.5rem;
                    font-weight: bold;
                    color: #ff5e62;
                    z-index: 202;
                    animation: stampGetEffect 2s ease-out;
                    pointer-events: none;
                    text-align: center;
                `;
                effectDiv.innerHTML = `
                    <div>${stampName}</div>
                    <div style="font-size: 1.8rem; margin-top: 10px;">ã‚¹ã‚¿ãƒ³ãƒ—GETï¼</div>
                `;
                
                // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«ã‚’è¿½åŠ 
                if (!document.getElementById('stamp-effect-style')) {
                    const style = document.createElement('style');
                    style.id = 'stamp-effect-style';
                    style.textContent = `
                        @keyframes stampGetEffect {
                            0% { 
                                opacity: 0;
                                transform: translate(-50%, -50%) scale(0.5);
                            }
                            50% { 
                                opacity: 1;
                                transform: translate(-50%, -50%) scale(1.2);
                            }
                            100% { 
                                opacity: 0;
                                transform: translate(-50%, -50%) scale(1);
                            }
                        }
                    `;
                    document.head.appendChild(style);
                }
                
                document.body.appendChild(effectDiv);
                
                // 2ç§’å¾Œã«å‰Šé™¤ã€3ç§’å¾Œã«ã‚¹ã‚¿ãƒ³ãƒ—ä¸€è¦§ç”»é¢ã«é·ç§»
                setTimeout(() => {
                    effectDiv.remove();
                    setTimeout(() => {
                        this.stopAR();
                        // ãƒšãƒ³ãƒ‡ã‚£ãƒ³ã‚°ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ã‚¯ãƒªã‚¢
                        sessionStorage.removeItem('pendingStamp');
                        this.pendingStamp = null;
                        this.showScreen('stamps');
                    }, 1000);
                }, 2000);
            },

            /**
             * ã‚¹ã‚¿ãƒ³ãƒ—ã‚·ãƒ¼ãƒˆã®è¡¨ç¤ºã‚’æ›´æ–°
             */
            renderStamps() {
                const stampGrid = document.getElementById('stamp-grid');
                if (!stampGrid) return;
                
                stampGrid.innerHTML = '';
                Object.keys(this.stamps).forEach(key => {
                    const stamp = this.stamps[key];
                    const item = document.createElement('div');
                    item.className = `stamp-item ${stamp.collected ? 'collected' : ''}`;
                    item.innerHTML = `
                        <img src="${stamp.img}" alt="${stamp.name}ã‚¹ã‚¿ãƒ³ãƒ—">
                        <p>${stamp.name}</p>
                        <small>${stamp.collected ? stamp.description : 'æœªç²å¾—'}</small>
                    `;
                    
                    // ç²å¾—æ¸ˆã¿ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ARè¡¨ç¤º
                    if (stamp.collected) {
                        item.addEventListener('click', () => {
                            // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«è¨­å®š
                            sessionStorage.setItem('pendingStamp', key);
                            this.pendingStamp = key;
                            this.showScreen('ar');
                        });
                    }
                    
                    stampGrid.appendChild(item);
                });
            }
        };
        
        // ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰æ™‚ã«ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚’åˆæœŸåŒ–
        window.addEventListener('DOMContentLoaded', function() {
            app.init();
        });

        // ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆï¼ˆé–‹ç™ºæ™‚ã®ã¿ï¼‰
        document.addEventListener('keydown', (e) => {
            // æ•°å­—ã‚­ãƒ¼1-8ã§ã‚¹ã‚¿ãƒ³ãƒ—è¿½åŠ ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
            if (e.key >= '1' && e.key <= '8') {
                const stamps = ['entrance', 'ticket', 'stage', 'bunmi1', 'bunmi2', 'yamato', 'rhythm', 'gym'];
                const stampType = stamps[parseInt(e.key) - 1];
                if (stampType) {
                    // ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«è¨­å®š
                    sessionStorage.setItem('pendingStamp', stampType);
                    app.pendingStamp = stampType;
                    app.collectStamp(stampType);
                    app.showScreen('ar');
                    app.log(`Debug: ã‚¹ã‚¿ãƒ³ãƒ—è¿½åŠ  ${stampType}`);
                }
            }
        });
    </script>
</body>
</html>