<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no, user-scalable=no">
    <title>AR Stamp Rally</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.5/aframe/build/aframe-ar.js"></script>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: #000;
            overflow: hidden;
        }
        
        /* スマホでカメラフィードを確実に表示 */
        #arjs-video {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            object-fit: cover !important;
            z-index: -1 !important;
        }
        
        /* A-Frameキャンバスを確実に表示 */
        .a-canvas {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            z-index: 1 !important;
        }
        
        #ui-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 999;
            pointer-events: none;
        }
        
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            pointer-events: all;
        }
        
        #startButton {
            background: #4CAF50;
            border: none;
            color: white;
            padding: 20px 40px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 18px;
            margin: 20px 2px;
            cursor: pointer;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            touch-action: manipulation;
        }
        
        #info {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 10px;
            font-size: 16px;
            text-align: center;
            pointer-events: none;
            border: 2px solid #4CAF50;
        }
        
        #debug {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(255, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            pointer-events: none;
            max-height: 100px;
            overflow-y: auto;
        }
        
        /* マーカー認識強化用のオーバーレイ */
        #marker-overlay {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 300px;
            height: 300px;
            border: 3px dashed #4CAF50;
            border-radius: 10px;
            pointer-events: none;
            z-index: 100;
        }
        
        #marker-overlay::after {
            content: "HIROマーカーをここに";
            position: absolute;
            top: -40px;
            left: 50%;
            transform: translateX(-50%);
            color: #4CAF50;
            font-size: 14px;
            background: rgba(0,0,0,0.8);
            padding: 5px 10px;
            border-radius: 5px;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* スマホ用の強制表示 */
        @media (max-width: 768px) {
            #arjs-video, .a-canvas {
                -webkit-transform: translateZ(0) !important;
                transform: translateZ(0) !important;
                -webkit-backface-visibility: hidden !important;
                backface-visibility: hidden !important;
                will-change: transform !important;
            }
        }
        
    </style>
</head>
<body>
    <div id="ui-overlay">
        <div id="loading">
            <h1>🎯 AR スタンプラリー</h1>
            <p id="status">タップして開始</p>
            <button id="startButton">📷 カメラを開始</button>
            <div style="margin-top: 20px; font-size: 14px; opacity: 0.8;">
                <p>HIROマーカー認識のコツ：</p>
                <p>• 明るい場所で使用</p>
                <p>• マーカーを平らに置く</p>
                <p>• 30cm程度の距離を保つ</p>
                <a href="https://github.com/AR-js-org/AR.js/blob/master/data/images/hiro.png" target="_blank" style="color: #4CAF50;">
                    📥 HIROマーカーをダウンロード
                </a>
            </div>
        </div>
        
        <div id="info" class="hidden">
            <div id="info-text">ARカメラ起動中...</div>
        </div>
        
        <div id="marker-overlay" class="hidden"></div>
        
        <div id="debug" class="hidden">
            <div id="debug-text">Debug info</div>
        </div>
    </div>

    <!-- AR Scene - マーカー認識を強化 -->
    <a-scene
        embedded
        arjs="sourceType: webcam; trackingMethod: best; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3; labelingMode: black_region; patternRatio: 0.8; maxDetectionRate: 60; canvasWidth: 640; canvasHeight: 480;"
        vr-mode-ui="enabled: false"
        device-orientation-permission-ui="enabled: false"
        loading-screen="enabled: false"
        inspector="url: false"
        keyboard-shortcuts="enabled: false"
        screenshot="enabled: false"
        renderer="logarithmicDepthBuffer: true; colorManagement: true; sortObjects: true; antialias: true; alpha: true;"
        background="transparent: true"
        style="z-index: 1;">
        
        <!-- マーカー認識を強化したHIROマーカー -->
        <a-marker 
            preset="hiro" 
            id="hiro-marker"
            smooth="true"
            smoothCount="5"
            smoothTolerance="0.01"
            smoothThreshold="2"
            raycaster="objects: .clickable"
            cursor="fuse: false; rayOrigin: mouse;">
            
            <!-- より目立つ3Dオブジェクト -->
            <a-box 
                position="0 0.5 0" 
                scale="0.8 0.8 0.8"
                color="#FFD700"
                metalness="0.1"
                roughness="0.3"
                animation="property: rotation; to: 0 360 0; loop: true; dur: 4000"
                shadow="cast: true; receive: false;">
            </a-box>
            
            <!-- 回転する装飾リング -->
            <a-torus 
                position="0 0.5 0" 
                color="#FF4444" 
                radius="0.8" 
                radius-tubular="0.1"
                animation="property: rotation; to: 360 0 0; loop: true; dur: 2000">
            </a-torus>
            
            <!-- 大きくて目立つテキスト -->
            <a-text 
                value="🎉 STAMP! 🎉"
                position="0 1.5 0"
                align="center"
                color="#FF0000"
                scale="3 3 3"
                font="kframe"
                animation="property: scale; to: 3.5 3.5 3.5; dir: alternate; loop: true; dur: 1000">
            </a-text>
            
            <!-- 発光エフェクト用の球体 -->
            <a-sphere 
                position="0 2 0" 
                radius="0.2" 
                color="#FFFF00"
                material="emissive: #FFFF00; emissiveIntensity: 0.5"
                animation="property: position; to: 0 2.5 0; dir: alternate; loop: true; dur: 1500">
            </a-sphere>
            
            <!-- 土台（影を受ける） -->
            <a-cylinder 
                position="0 0 0" 
                radius="1.2" 
                height="0.1" 
                color="#8B4513"
                shadow="receive: true; cast: false">
            </a-cylinder>
            
        </a-marker>
        
        <a-entity 
            camera 
            look-controls-enabled="false"
            wasd-controls-enabled="false">
        </a-entity>
    </a-scene>

    <script>
        const startButton = document.getElementById('startButton');
        const loading = document.getElementById('loading');
        const info = document.getElementById('info');
        const status = document.getElementById('status');
        const infoText = document.getElementById('info-text');
        const debug = document.getElementById('debug');
        const debugText = document.getElementById('debug-text');
        const markerOverlay = document.getElementById('marker-overlay');
        
        let cameraStarted = false;
        let arStarted = false;
        let markerFound = false;
        let debugLog = [];
        
        // デバッグ情報表示
        function updateDebug(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `${timestamp}: ${message}`;
            console.log("🔍 " + logEntry);
            
            debugLog.push(logEntry);
            if (debugLog.length > 10) debugLog.shift(); // 最新10件のみ保持
            
            debugText.innerHTML = debugLog.join('<br>');
            debug.classList.remove('hidden');
        }
        
        // デバイス検出
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        const isAndroid = /Android/.test(navigator.userAgent);
        const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
        const isMobile = isIOS || isAndroid;
        
        updateDebug(`Device: ${isIOS ? 'iOS' : isAndroid ? 'Android' : 'Desktop'} ${isSafari ? 'Safari' : 'Other'}`);
        
        // スマホ用の強制カメラ表示
        function forceVideoDisplay() {
            updateDebug("Forcing video display for mobile...");
            
            // AR.jsのビデオ要素を探して強制表示
            const checkVideo = setInterval(() => {
                const video = document.querySelector('#arjs-video') || document.querySelector('video');
                if (video) {
                    updateDebug("Found video element, applying mobile styles");
                    
                    video.style.position = 'fixed';
                    video.style.top = '0';
                    video.style.left = '0';
                    video.style.width = '100%';
                    video.style.height = '100%';
                    video.style.objectFit = 'cover';
                    video.style.zIndex = '-1';
                    video.style.transform = 'translateZ(0)';
                    video.style.webkitTransform = 'translateZ(0)';
                    video.style.backfaceVisibility = 'hidden';
                    video.style.webkitBackfaceVisibility = 'hidden';
                    
                    // スマホの場合、ビデオの可視性を強制
                    if (isMobile) {
                        video.style.visibility = 'visible';
                        video.style.opacity = '1';
                        video.style.display = 'block';
                        updateDebug("Applied mobile video visibility fixes");
                    }
                    
                    clearInterval(checkVideo);
                }
            }, 100);
            
            // 10秒後にタイムアウト
            setTimeout(() => clearInterval(checkVideo), 10000);
        }
        
        startButton.addEventListener('click', async function() {
            updateDebug("Start button clicked");
            status.textContent = "カメラにアクセス中...";
            
            try {
                // Step 1: カメラ許可を取得
                updateDebug("Requesting camera access...");
                
                const constraints = {
                    video: {
                        facingMode: { ideal: 'environment' },
                        width: { ideal: 640, max: 1280 },
                        height: { ideal: 480, max: 720 }
                    }
                };
                
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                updateDebug(`Camera stream obtained: ${stream.getVideoTracks().length} tracks`);
                
                // ストリーム情報をログ
                const track = stream.getVideoTracks()[0];
                const settings = track.getSettings();
                updateDebug(`Video: ${settings.width}x${settings.height}, facing: ${settings.facingMode}`);
                
                // すぐにストリームを停止（AR.jsが独自に管理するため）
                stream.getTracks().forEach(track => track.stop());
                cameraStarted = true;
                
                // Step 2: UIを切り替え
                status.textContent = "ARを初期化中...";
                updateDebug("Starting AR initialization...");
                
                // スマホ用の強制ビデオ表示を開始
                if (isMobile) {
                    forceVideoDisplay();
                }
                
                // デバイス別待機時間
                const waitTime = isMobile ? (isIOS ? 5000 : 4000) : 2000;
                updateDebug(`Waiting ${waitTime}ms for AR initialization...`);
                
                setTimeout(() => {
                    loading.classList.add('hidden');
                    info.classList.remove('hidden');
                    markerOverlay.classList.remove('hidden');
                    infoText.textContent = "HIROマーカーを中央のガイドに合わせてください";
                    
                    updateDebug("UI switched, setting up AR listeners...");
                    
                    // Step 3: ARイベントリスナーを設定
                    setupARListeners();
                    
                    // Step 4: ARが実際に動作しているかチェック
                    setTimeout(checkARStatus, 3000);
                    
                }, waitTime);
                
            } catch (error) {
                updateDebug(`Camera error: ${error.name} - ${error.message}`);
                handleCameraError(error);
            }
        });
        
        function setupARListeners() {
            const marker = document.getElementById('hiro-marker');
            const scene = document.querySelector('a-scene');
            
            if (marker) {
                marker.addEventListener('markerFound', function() {
                    updateDebug("🎉 HIRO marker FOUND!");
                    markerFound = true;
                    infoText.innerHTML = `
                        <div style="color: #00FF00; font-size: 20px;">🎉 スタンプ発見！</div>
                        <div>マーカーを安定して保持してください</div>
                    `;
                    info.style.borderColor = "#00FF00";
                    markerOverlay.style.borderColor = "#00FF00";
                    markerOverlay.style.boxShadow = "0 0 20px #00FF00";
                });
                
                marker.addEventListener('markerLost', function() {
                    updateDebug("❌ HIRO marker lost");
                    markerFound = false;
                    infoText.innerHTML = `
                        <div>HIROマーカーを中央のガイドに合わせてください</div>
                        <div style="font-size: 12px; margin-top: 5px;">明るい場所で、30cm程度の距離を保ってください</div>
                    `;
                    info.style.borderColor = "#4CAF50";
                    markerOverlay.style.borderColor = "#4CAF50";
                    markerOverlay.style.boxShadow = "none";
                });
            }
            
            if (scene) {
                scene.addEventListener('arjs-video-loaded', function() {
                    updateDebug("📹 AR.js video loaded successfully!");
                    arStarted = true;
                });
                
                scene.addEventListener('camera-init', function() {
                    updateDebug("📷 Camera initialized by AR.js");
                });
                
                // レンダリング開始を検出
                scene.addEventListener('renderstart', function() {
                    updateDebug("🎮 AR scene render started");
                });
            }
        }
        
        function checkARStatus() {
            const scene = document.querySelector('a-scene');
            const canvas = scene ? scene.canvas : null;
            const video = document.querySelector('#arjs-video') || document.querySelector('video');
            
            updateDebug(`Status check - Scene: ${!!scene}, Canvas: ${!!canvas}, Video: ${!!video}, Started: ${arStarted}`);
            
            if (!arStarted && !video) {
                updateDebug("⚠️ AR not properly initialized, trying recovery...");
                infoText.innerHTML = `
                    <div style="color: #FFA500;">ARの初期化に時間がかかっています...</div>
                    <div style="font-size: 12px; margin-top: 10px;">
                        しばらくお待ちください。改善されない場合はページを再読み込みしてください。
                    </div>
                `;
                
                // さらに時間を待つ
                setTimeout(() => {
                    if (!arStarted) {
                        updateDebug("❗ AR initialization timeout");
                        infoText.innerHTML = `
                            <div style="color: #FF4444;">ARの初期化でエラーが発生しました</div>
                            <div style="font-size: 12px; margin-top: 10px;">
                                <button onclick="location.reload()" style="padding: 8px 16px; background: #4CAF50; color: white; border: none; border-radius: 5px;">
                                    🔄 再読み込み
                                </button>
                            </div>
                        `;
                    }
                }, 8000);
            } else {
                updateDebug("✅ AR appears to be working");
                infoText.innerHTML = `
                    <div>HIROマーカーを中央のガイドに合わせてください</div>
                    <div style="font-size: 12px; margin-top: 5px; color: #00FF00;">
                        ARカメラが正常に動作しています
                    </div>
                `;
            }
        }
        
        function handleCameraError(error) {
            let errorMessage = "カメラエラーが発生しました";
            let solution = "";
            
            switch (error.name) {
                case 'NotAllowedError':
                    errorMessage = "カメラの許可が拒否されました";
                    solution = "ブラウザの設定でカメラを許可してください";
                    break;
                case 'NotFoundError':
                    errorMessage = "カメラが見つかりません";
                    solution = "デバイスにカメラがあることを確認してください";
                    break;
                case 'NotSupportedError':
                    errorMessage = "このブラウザはカメラをサポートしていません";
                    solution = "Chrome、Firefox、Safariをお試しください";
                    break;
                case 'OverconstrainedError':
                    errorMessage = "カメラの設定に問題があります";
                    solution = "別のカメラまたはブラウザをお試しください";
                    break;
            }
            
            status.innerHTML = `
                <div style="color: #ff4444; margin-bottom: 10px;">${errorMessage}</div>
                <div style="font-size: 14px; margin-bottom: 15px;">${solution}</div>
                <button onclick="location.reload()" style="padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 5px;">
                    🔄 再読み込み
                </button>
            `;
        }
        
        // ページ読み込み時のチェック
        window.addEventListener('load', () => {
            updateDebug("Page loaded, running compatibility checks...");
            
            const checks = {
                'HTTPS': location.protocol === 'https:',
                'MediaDevices': 'mediaDevices' in navigator,
                'getUserMedia': navigator.mediaDevices && 'getUserMedia' in navigator.mediaDevices,
                'WebGL': !!window.WebGLRenderingContext,
                'A-Frame': typeof AFRAME !== 'undefined'
            };
            
            const failedChecks = Object.entries(checks).filter(([key, value]) => !value).map(([key]) => key);
            
            if (failedChecks.length > 0) {
                updateDebug(`❌ Failed checks: ${failedChecks.join(', ')}`);
            } else {
                updateDebug("✅ All compatibility checks passed");
            }
            
            // スマホでの追加チェック
            if (isMobile) {
                updateDebug(`Mobile device detected - applying mobile optimizations`);
            }
        });
        
    </script>
</body>
</html>
