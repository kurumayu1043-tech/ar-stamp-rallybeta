<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no, user-scalable=no">
    <title>AR Stamp Rally - Enhanced</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.5/aframe/build/aframe-ar.js"></script>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: #000;
            overflow: hidden;
        }
        
        /* ã‚«ãƒ¡ãƒ©ãƒ•ã‚£ãƒ¼ãƒ‰ã®å¼·åˆ¶è¡¨ç¤º */
        #arjs-video {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            object-fit: cover !important;
            z-index: -1 !important;
        }
        
        .a-canvas {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            z-index: 1 !important;
        }
        
        #ui-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 999;
            pointer-events: none;
        }
        
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            pointer-events: all;
        }
        
        #startButton {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            border: none;
            color: white;
            padding: 20px 40px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 18px;
            margin: 20px 2px;
            cursor: pointer;
            border-radius: 10px;
            box-shadow: 0 4px 16px rgba(76,175,80,0.4);
            touch-action: manipulation;
            transition: all 0.3s ease;
        }
        
        #startButton:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76,175,80,0.6);
        }
        
        #info {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 10px;
            font-size: 16px;
            text-align: center;
            pointer-events: none;
            border: 2px solid #4CAF50;
            backdrop-filter: blur(10px);
            transition: all 0.3s ease;
        }
        
        #debug {
            position: fixed;
            bottom: 80px;
            left: 20px;
            right: 20px;
            background: rgba(255, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            pointer-events: none;
            max-height: 100px;
            overflow-y: auto;
            backdrop-filter: blur(5px);
        }
        
        /* æ”¹è‰¯ã•ã‚ŒãŸãƒãƒ¼ã‚«ãƒ¼ã‚¬ã‚¤ãƒ‰ */
        #marker-guide {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 250px;
            height: 250px;
            border: 3px solid #4CAF50;
            border-radius: 15px;
            pointer-events: none;
            z-index: 100;
            box-shadow: 0 0 20px rgba(76, 175, 80, 0.5);
            transition: all 0.3s ease;
        }
        
        #marker-guide::before {
            content: "";
            position: absolute;
            top: -10px;
            left: -10px;
            right: -10px;
            bottom: -10px;
            border: 2px dashed rgba(76, 175, 80, 0.5);
            border-radius: 20px;
            animation: pulse 2s infinite;
        }
        
        #marker-guide::after {
            content: "HIROãƒãƒ¼ã‚«ãƒ¼ã‚’ã“ã“ã«é…ç½®";
            position: absolute;
            top: -50px;
            left: 50%;
            transform: translateX(-50%);
            color: #4CAF50;
            font-size: 14px;
            background: rgba(0,0,0,0.8);
            padding: 8px 15px;
            border-radius: 20px;
            white-space: nowrap;
            border: 1px solid #4CAF50;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 0.4; }
            50% { opacity: 0.8; }
        }
        
        /* ãƒãƒ¼ã‚«ãƒ¼èªè­˜æ™‚ã®ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
        .marker-found {
            border-color: #00FF00 !important;
            box-shadow: 0 0 30px #00FF00 !important;
            animation: found-pulse 1s infinite;
        }
        
        @keyframes found-pulse {
            0%, 100% { transform: translate(-50%, -50%) scale(1); }
            50% { transform: translate(-50%, -50%) scale(1.1); }
        }
        
        /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–èª¿æ•´ */
        @media (max-width: 480px) {
            #marker-guide {
                width: 200px;
                height: 200px;
            }
            
            #info {
                font-size: 14px;
                padding: 12px;
            }
        }
        
        .hidden {
            display: none !important;
        }
        
        /* ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ– */
        * {
            -webkit-transform: translateZ(0);
            transform: translateZ(0);
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
        }
        
        /* ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ã®ã‚¹ã‚¿ã‚¤ãƒ« */
        #download-link {
            display: inline-block;
            color: #4CAF50;
            text-decoration: none;
            padding: 10px 20px;
            border: 1px solid #4CAF50;
            border-radius: 8px;
            margin-top: 15px;
            transition: all 0.3s ease;
        }
        
        #download-link:hover {
            background: #4CAF50;
            color: white;
        }
    </style>
</head>
<body>
    <div id="ui-overlay">
        <div id="loading">
            <h1>ğŸ¯ AR ã‚¹ã‚¿ãƒ³ãƒ—ãƒ©ãƒªãƒ¼</h1>
            <div style="margin-bottom: 20px;">
                <div style="font-size: 18px; margin-bottom: 10px;">ğŸ“· é«˜ç²¾åº¦ãƒãƒ¼ã‚«ãƒ¼èªè­˜</div>
                <div style="font-size: 14px; opacity: 0.8;">Enhanced HIRO Detection System</div>
            </div>
            <p id="status">ã‚¿ãƒƒãƒ—ã—ã¦é–‹å§‹</p>
            <button id="startButton">ğŸ“· ã‚«ãƒ¡ãƒ©ã‚’é–‹å§‹</button>
            <div style="margin-top: 25px; font-size: 14px; opacity: 0.9; text-align: left; max-width: 300px;">
                <div style="margin-bottom: 15px; color: #4CAF50; font-weight: bold;">ğŸ¯ èªè­˜ç²¾åº¦å‘ä¸Šã®ã‚³ãƒ„ï¼š</div>
                <div style="margin-bottom: 8px;">âœ“ ååˆ†ã«æ˜ã‚‹ã„å ´æ‰€ã§ä½¿ç”¨</div>
                <div style="margin-bottom: 8px;">âœ“ ãƒãƒ¼ã‚«ãƒ¼ã‚’å¹³ã‚‰ã«é…ç½®</div>
                <div style="margin-bottom: 8px;">âœ“ 20-40cmç¨‹åº¦ã®è·é›¢ã‚’ä¿æŒ</div>
                <div style="margin-bottom: 8px;">âœ“ ã‚«ãƒ¡ãƒ©ã‚’å®‰å®šã•ã›ã‚‹</div>
                <div style="margin-bottom: 15px;">âœ“ ãƒãƒ¼ã‚«ãƒ¼ã®å››è§’ã‚’ç”»é¢å†…ã«å®Œå…¨ã«åã‚ã‚‹</div>
                <a href="https://github.com/AR-js-org/AR.js/blob/master/data/images/hiro.png" 
                   target="_blank" 
                   id="download-link">
                    ğŸ“¥ HIROãƒãƒ¼ã‚«ãƒ¼ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                </a>
            </div>
        </div>
        
        <div id="info" class="hidden">
            <div id="info-text">ARã‚«ãƒ¡ãƒ©èµ·å‹•ä¸­...</div>
        </div>
        
        <div id="marker-guide" class="hidden"></div>
        
        <div id="debug" class="hidden">
            <div id="debug-text">Debug info</div>
        </div>
    </div>

    <!-- æœ€é©åŒ–ã•ã‚ŒãŸAR Scene -->
    <a-scene
        embedded
        arjs="sourceType: webcam; 
              trackingMethod: best; 
              debugUIEnabled: false; 
              detectionMode: mono_and_matrix; 
              matrixCodeType: 3x3; 
              labelingMode: black_region; 
              patternRatio: 0.75;
              maxDetectionRate: 90;
              canvasWidth: 800;
              canvasHeight: 600;
              cameraNear: 0.01;
              cameraFar: 1000;
              sourceWidth: 800;
              sourceHeight: 600;"
        vr-mode-ui="enabled: false"
        device-orientation-permission-ui="enabled: false"
        loading-screen="enabled: false"
        inspector="url: false"
        keyboard-shortcuts="enabled: false"
        screenshot="enabled: false"
        renderer="logarithmicDepthBuffer: true; 
                  colorManagement: true; 
                  sortObjects: true; 
                  antialias: true; 
                  alpha: true;
                  precision: highp;
                  powerPreference: high-performance;"
        background="transparent: true"
        style="z-index: 1;">
        
        <!-- é«˜ç²¾åº¦HIROãƒãƒ¼ã‚«ãƒ¼è¨­å®š -->
        <a-marker 
            preset="hiro" 
            id="hiro-marker"
            smooth="true"
            smoothCount="10"
            smoothTolerance="0.005"
            smoothThreshold="1"
            raycaster="objects: .clickable"
            cursor="fuse: false; rayOrigin: mouse"
            markerhandler>
            
            <!-- ãƒ¡ã‚¤ãƒ³ã®å›è»¢ãƒœãƒƒã‚¯ã‚¹ -->
            <a-box 
                position="0 0.5 0" 
                scale="0.6 0.6 0.6"
                color="#FFD700"
                metalness="0.2"
                roughness="0.1"
                animation="property: rotation; to: 0 360 0; loop: true; dur: 3000; easing: linear"
                shadow="cast: true; receive: false;">
                
                <!-- ãƒœãƒƒã‚¯ã‚¹å†…éƒ¨ã®å°ã•ãªçƒ -->
                <a-sphere 
                    position="0 0 0" 
                    radius="0.3" 
                    color="#FF4444"
                    material="emissive: #FF2222; emissiveIntensity: 0.3"
                    animation="property: scale; to: 1.2 1.2 1.2; dir: alternate; loop: true; dur: 1000">
                </a-sphere>
            </a-box>
            
            <!-- å¤–å´ã®å›è»¢ãƒªãƒ³ã‚° -->
            <a-torus 
                position="0 0.5 0" 
                color="#00FF88" 
                radius="0.8" 
                radius-tubular="0.08"
                material="emissive: #00FF88; emissiveIntensity: 0.4"
                animation="property: rotation; to: 360 0 360; loop: true; dur: 4000; easing: linear">
            </a-torus>
            
            <!-- ä¸Šä¸‹ã«å‹•ãè£…é£¾çƒ -->
            <a-sphere 
                position="0 1.8 0" 
                radius="0.15" 
                color="#FFFF00"
                material="emissive: #FFFF00; emissiveIntensity: 0.6"
                animation="property: position; to: 0 0.2 0; dir: alternate; loop: true; dur: 2000">
            </a-sphere>
            
            <!-- æˆåŠŸãƒ†ã‚­ã‚¹ãƒˆ -->
            <a-text 
                value="ğŸ‰ STAMP GET! ğŸ‰"
                position="0 1.2 0"
                align="center"
                color="#FF0000"
                scale="2.5 2.5 2.5"
                font="kframe"
                material="emissive: #FF0000; emissiveIntensity: 0.3"
                animation="property: rotation; to: 0 360 0; loop: true; dur: 6000">
            </a-text>
            
            <!-- ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«é¢¨ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ -->
            <a-cylinder 
                position="1 0.5 0" 
                radius="0.05" 
                height="0.3" 
                color="#FF69B4"
                animation="property: rotation; to: 0 0 360; loop: true; dur: 1000">
            </a-cylinder>
            
            <a-cylinder 
                position="-1 0.5 0" 
                radius="0.05" 
                height="0.3" 
                color="#FF69B4"
                animation="property: rotation; to: 0 0 -360; loop: true; dur: 1000">
            </a-cylinder>
            
            <a-cylinder 
                position="0 0.5 1" 
                radius="0.05" 
                height="0.3" 
                color="#FF69B4"
                animation="property: rotation; to: 360 0 0; loop: true; dur: 1000">
            </a-cylinder>
            
            <a-cylinder 
                position="0 0.5 -1" 
                radius="0.05" 
                height="0.3" 
                color="#FF69B4"
                animation="property: rotation; to: -360 0 0; loop: true; dur: 1000">
            </a-cylinder>
            
            <!-- åœŸå° -->
            <a-cylinder 
                position="0 0 0" 
                radius="1.0" 
                height="0.05" 
                color="#8B4513"
                shadow="receive: true; cast: false">
            </a-cylinder>
            
        </a-marker>
        
        <a-entity 
            camera 
            look-controls-enabled="false"
            wasd-controls-enabled="false"
            position="0 0 0">
        </a-entity>
    </a-scene>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        const startButton = document.getElementById('startButton');
        const loading = document.getElementById('loading');
        const info = document.getElementById('info');
        const status = document.getElementById('status');
        const infoText = document.getElementById('info-text');
        const debug = document.getElementById('debug');
        const debugText = document.getElementById('debug-text');
        const markerGuide = document.getElementById('marker-guide');
        
        let cameraStarted = false;
        let arStarted = false;
        let markerFound = false;
        let markerLostCount = 0;
        let markerFoundCount = 0;
        let debugLog = [];
        let frameCount = 0;
        let lastFrameTime = Date.now();
        
        // ãƒ‡ãƒã‚¤ã‚¹æ¤œå‡ºï¼ˆå¼·åŒ–ç‰ˆï¼‰
        const userAgent = navigator.userAgent.toLowerCase();
        const isIOS = /ipad|iphone|ipod/.test(userAgent);
        const isAndroid = /android/.test(userAgent);
        const isSafari = /safari/.test(userAgent) && !/chrome/.test(userAgent);
        const isChrome = /chrome/.test(userAgent);
        const isMobile = isIOS || isAndroid;
        
        // ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½å¼·åŒ–
        function updateDebug(message, level = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const emoji = level === 'error' ? 'âŒ' : level === 'success' ? 'âœ…' : level === 'warning' ? 'âš ï¸' : 'ğŸ”';
            const logEntry = `${emoji} ${timestamp}: ${message}`;
            
            console.log(logEntry);
            
            debugLog.push(logEntry);
            if (debugLog.length > 15) debugLog.shift();
            
            debugText.innerHTML = debugLog.join('<br>');
            debug.classList.remove('hidden');
            
            // FPSè¨ˆç®—
            frameCount++;
            const now = Date.now();
            if (now - lastFrameTime > 1000) {
                const fps = Math.round(frameCount * 1000 / (now - lastFrameTime));
                frameCount = 0;
                lastFrameTime = now;
                
                if (arStarted) {
                    const fpsInfo = `ğŸ“Š FPS: ${fps} | Found: ${markerFoundCount} | Lost: ${markerLostCount}`;
                    debugLog[debugLog.length - 1] = fpsInfo;
                    debugText.innerHTML = debugLog.join('<br>');
                }
            }
        }
        
        updateDebug(`Device: ${isIOS ? 'iOS' : isAndroid ? 'Android' : 'Desktop'} Browser: ${isChrome ? 'Chrome' : isSafari ? 'Safari' : 'Other'}`, 'info');
        
        // ã‚«ãƒ¡ãƒ©è¨­å®šæœ€é©åŒ–
        function getCameraConstraints() {
            const baseConstraints = {
                video: {
                    width: { ideal: 800, max: 1920 },
                    height: { ideal: 600, max: 1080 },
                    frameRate: { ideal: 30, max: 60 }
                }
            };
            
            // ãƒ‡ãƒã‚¤ã‚¹åˆ¥æœ€é©åŒ–
            if (isIOS) {
                baseConstraints.video.facingMode = { exact: 'environment' };
                baseConstraints.video.width = { ideal: 640, max: 1280 };
                baseConstraints.video.height = { ideal: 480, max: 720 };
            } else if (isAndroid) {
                baseConstraints.video.facingMode = { ideal: 'environment' };
            } else {
                baseConstraints.video.facingMode = 'environment';
            }
            
            return baseConstraints;
        }
        
        // å¼·åŒ–ã•ã‚ŒãŸãƒ“ãƒ‡ã‚ªè¡¨ç¤º
        function enhanceVideoDisplay() {
            updateDebug("Enhancing video display...", 'info');
            
            const checkVideo = setInterval(() => {
                const video = document.querySelector('#arjs-video') || 
                            document.querySelector('video') || 
                            document.querySelector('canvas + video');
                            
                if (video) {
                    updateDebug(`Video found: ${video.videoWidth}x${video.videoHeight}`, 'success');
                    
                    // ã‚¹ã‚¿ã‚¤ãƒ«é©ç”¨
                    Object.assign(video.style, {
                        position: 'fixed',
                        top: '0',
                        left: '0',
                        width: '100%',
                        height: '100%',
                        objectFit: 'cover',
                        zIndex: '-1',
                        visibility: 'visible',
                        opacity: '1',
                        display: 'block',
                        transform: 'translateZ(0)',
                        backfaceVisibility: 'hidden'
                    });
                    
                    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¿½åŠ 
                    video.addEventListener('loadeddata', () => {
                        updateDebug(`Video loaded: ${video.videoWidth}x${video.videoHeight}`, 'success');
                        arStarted = true;
                    });
                    
                    video.addEventListener('error', (e) => {
                        updateDebug(`Video error: ${e.message}`, 'error');
                    });
                    
                    clearInterval(checkVideo);
                } else {
                    updateDebug("Video element not found, retrying...", 'warning');
                }
            }, 200);
            
            setTimeout(() => {
                clearInterval(checkVideo);
                if (!arStarted) {
                    updateDebug("Video detection timeout", 'error');
                }
            }, 15000);
        }
        
        // ãƒãƒ¼ã‚«ãƒ¼ã‚¤ãƒ™ãƒ³ãƒˆãƒãƒ³ãƒ‰ãƒ©ãƒ¼ï¼ˆå¼·åŒ–ç‰ˆï¼‰
        AFRAME.registerComponent('markerhandler', {
            init: function () {
                const marker = this.el;
                
                marker.addEventListener('markerFound', function() {
                    markerFoundCount++;
                    markerFound = true;
                    updateDebug(`ğŸ‰ HIRO marker FOUND! (${markerFoundCount} times)`, 'success');
                    
                    // UIæ›´æ–°
                    infoText.innerHTML = `
                        <div style="color: #00FF00; font-size: 22px; margin-bottom: 10px;">
                            ğŸ‰ ã‚¹ã‚¿ãƒ³ãƒ—ã‚²ãƒƒãƒˆï¼
                        </div>
                        <div style="font-size: 14px;">
                            ãƒãƒ¼ã‚«ãƒ¼ã‚’å®‰å®šã—ã¦ä¿æŒã—ã¦ãã ã•ã„
                        </div>
                        <div style="font-size: 12px; margin-top: 8px; opacity: 0.8;">
                            èªè­˜å›æ•°: ${markerFoundCount} | ç²¾åº¦: ${Math.round((markerFoundCount/(markerFoundCount+markerLostCount))*100) || 100}%
                        </div>
                    `;
                    
                    info.style.borderColor = "#00FF00";
                    info.style.backgroundColor = "rgba(0, 255, 0, 0.1)";
                    markerGuide.classList.add('marker-found');
                });
                
                marker.addEventListener('markerLost', function() {
                    markerLostCount++;
                    markerFound = false;
                    updateDebug(`âŒ HIRO marker lost (${markerLostCount} times)`, 'warning');
                    
                    // UIæ›´æ–°
                    infoText.innerHTML = `
                        <div style="font-size: 16px; margin-bottom: 8px;">
                            HIROãƒãƒ¼ã‚«ãƒ¼ã‚’ä¸­å¤®ã®ã‚¬ã‚¤ãƒ‰ã«åˆã‚ã›ã¦ãã ã•ã„
                        </div>
                        <div style="font-size: 13px; color: #FFA500; margin-bottom: 8px;">
                            ğŸ’¡ ã‚³ãƒ„ï¼šãƒãƒ¼ã‚«ãƒ¼ã®å››éš…ãŒç”»é¢å†…ã«å®Œå…¨ã«å…¥ã‚‹ã‚ˆã†ã«ã—ã¦ãã ã•ã„
                        </div>
                        <div style="font-size: 12px; opacity: 0.7;">
                            èªè­˜å±¥æ­´: æˆåŠŸ ${markerFoundCount} | å¤±æ•— ${markerLostCount}
                        </div>
                    `;
                    
                    info.style.borderColor = "#4CAF50";
                    info.style.backgroundColor = "rgba(0, 0, 0, 0.8)";
                    markerGuide.classList.remove('marker-found');
                });
            }
        });
        
        // ãƒ¡ã‚¤ãƒ³ã®é–‹å§‹å‡¦ç†
        startButton.addEventListener('click', async function() {
            updateDebug("Start button clicked", 'info');
            status.textContent = "ã‚«ãƒ¡ãƒ©ã«ã‚¢ã‚¯ã‚»ã‚¹ä¸­...";
            
            try {
                // ã‚«ãƒ¡ãƒ©è¨±å¯å–å¾—
                updateDebug("Requesting camera access with optimized constraints...", 'info');
                
                const constraints = getCameraConstraints();
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                
                const track = stream.getVideoTracks()[0];
                const settings = track.getSettings();
                updateDebug(`Camera: ${settings.width}x${settings.height}@${settings.frameRate}fps, facing: ${settings.facingMode}`, 'success');
                
                // ã‚¹ãƒˆãƒªãƒ¼ãƒ åœæ­¢ï¼ˆAR.jsãŒç®¡ç†ã™ã‚‹ãŸã‚ï¼‰
                stream.getTracks().forEach(track => track.stop());
                cameraStarted = true;
                
                // UIåˆ‡ã‚Šæ›¿ãˆ
                status.textContent = "ARã‚¨ãƒ³ã‚¸ãƒ³ã‚’åˆæœŸåŒ–ä¸­...";
                updateDebug("Starting AR.js initialization...", 'info');
                
                // å¼·åŒ–ã•ã‚ŒãŸãƒ“ãƒ‡ã‚ªè¡¨ç¤ºã‚’é–‹å§‹
                enhanceVideoDisplay();
                
                // ãƒ‡ãƒã‚¤ã‚¹åˆ¥å¾…æ©Ÿæ™‚é–“
                const waitTime = isMobile ? (isIOS ? 6000 : 5000) : 3000;
                updateDebug(`Waiting ${waitTime}ms for AR initialization...`, 'info');
                
                setTimeout(() => {
                    loading.classList.add('hidden');
                    info.classList.remove('hidden');
                    markerGuide.classList.remove('hidden');
                    
                    infoText.innerHTML = `
                        <div style="color: #4CAF50; font-size: 18px; margin-bottom: 10px;">
                            ğŸ“· ARã‚«ãƒ¡ãƒ©ãŒèµ·å‹•ã—ã¾ã—ãŸ
                        </div>
                        <div style="margin-bottom: 8px;">
                            HIROãƒãƒ¼ã‚«ãƒ¼ã‚’ä¸­å¤®ã®ã‚¬ã‚¤ãƒ‰ã«åˆã‚ã›ã¦ãã ã•ã„
                        </div>
                        <div style="font-size: 13px; opacity: 0.8;">
                            ğŸ’¡ æ˜ã‚‹ã„å ´æ‰€ã§ã€20-40cmç¨‹åº¦ã®è·é›¢ã‚’ä¿ã£ã¦ãã ã•ã„
                        </div>
                    `;
                    
                    updateDebug("UI switched, AR ready for marker detection", 'success');
                    
                    // ARçŠ¶æ…‹ç›£è¦–é–‹å§‹
                    monitorARStatus();
                    
                }, waitTime);
                
            } catch (error) {
                updateDebug(`Camera error: ${error.name} - ${error.message}`, 'error');
                handleCameraError(error);
            }
        });
        
        // ARçŠ¶æ…‹ç›£è¦–
        function monitorARStatus() {
            const checkInterval = setInterval(() => {
                const scene = document.querySelector('a-scene');
                const canvas = scene ? scene.canvas : null;
                const video = document.querySelector('#arjs-video') || document.querySelector('video');
                
                if (arStarted && video && canvas) {
                    updateDebug("âœ… AR system fully operational", 'success');
                    clearInterval(checkInterval);
                } else if (Date.now() - lastFrameTime > 10000) {
                    updateDebug("âš ï¸ AR initialization taking longer than expected", 'warning');
                    
                    infoText.innerHTML = `
                        <div style="color: #FFA500; margin-bottom: 10px;">
                            ARã®åˆæœŸåŒ–ã«æ™‚é–“ãŒã‹ã‹ã£ã¦ã„ã¾ã™...
                        </div>
                        <div style="font-size: 14px; margin-bottom: 15px;">
                            ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚æ”¹å–„ã•ã‚Œãªã„å ´åˆã¯å†èª­ã¿è¾¼ã¿ã‚’ãŠè©¦ã—ãã ã•ã„ã€‚
                        </div>
                        <div style="font-size: 12px;">
                            <button onclick="location.reload()" style="padding: 8px 16px; background: #4CAF50; color: white; border: none; border-radius: 5px; cursor: pointer;">
                                ğŸ”„ å†èª­ã¿è¾¼ã¿
                            </button>
                        </div>
                    `;
                }
            }, 2000);
        }
        
        // ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
        function handleCameraError(error) {
            const errorMap = {
                'NotAllowedError': {
                    title: 'ã‚«ãƒ¡ãƒ©ã®è¨±å¯ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ',
                    solution: 'ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã§ã‚«ãƒ¡ãƒ©ã‚¢ã‚¯ã‚»ã‚¹ã‚’è¨±å¯ã—ã¦ãã ã•ã„'
                },
                'NotFoundError': {
                    title: 'ã‚«ãƒ¡ãƒ©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“',
                    solution: 'ãƒ‡ãƒã‚¤ã‚¹ã«ã‚«ãƒ¡ãƒ©ãŒæ¥ç¶šã•ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„'
                },
                'NotSupportedError': {
                    title: 'ãƒ–ãƒ©ã‚¦ã‚¶ãŒã‚«ãƒ¡ãƒ©ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“',
                    solution: 'Chromeã€Firefoxã€Edgeã€Safariã‚’ãŠè©¦ã—ãã ã•ã„'
                },
                'OverconstrainedError': {
                    title: 'ã‚«ãƒ¡ãƒ©ã®è¨­å®šã«å•é¡ŒãŒã‚ã‚Šã¾ã™',
                    solution: 'åˆ¥ã®ã‚«ãƒ¡ãƒ©ã¾ãŸã¯ãƒ–ãƒ©ã‚¦ã‚¶ã‚’ãŠè©¦ã—ãã ã•ã„'
                }
            };
            
            const errorInfo = errorMap[error.name] || {
                title: 'ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ',
                solution: 'ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãŠè©¦ã—ãã ã•ã„'
            };
            
            status.innerHTML = `
                <div style="color: #ff4444; font-size: 18px; margin-bottom: 15px;">${errorInfo.title}</div>
                <div style="font-size: 14px; margin-bottom: 20px; line-height: 1.4;">${errorInfo.solution}</div>
                <button onclick="location.reload()" style="padding: 12px 24px; background: #4CAF50; color: white; border: none; border-radius: 8px; font-size: 16px; cursor: pointer;">
                    ğŸ”„ å†èª­ã¿è¾¼ã¿
                </button>
            `;
        }
        
        // äº’æ›æ€§ãƒã‚§ãƒƒã‚¯ï¼ˆå¼·åŒ–ç‰ˆï¼‰
        window.addEventListener('load', () => {
            updateDebug("Running enhanced compatibility checks...", 'info');
            
            const checks = {
                'HTTPS/Localhost': location.protocol === 'https:' || location.hostname === 'localhost',
                'MediaDevices': 'mediaDevices' in navigator,
                'getUserMedia': navigator.mediaDevices && 'getUserMedia' in navigator.mediaDevices,
                'WebGL': !!window.WebGLRenderingContext,
                'WebGL2': !!window.WebGL2RenderingContext,
                'A-Frame': typeof AFRAME !== 'undefined',
                'AR.js': typeof THREEx !== 'undefined'
            };
            
            const passedChecks = Object.entries(checks).filter(([key, value]) => value).map(([key]) => key);
            const failedChecks = Object.entries(checks).filter(([key, value]) => !value).map(([key]) => key);
            
            if (failedChecks.length > 0) {
                updateDebug(`âŒ Failed: ${failedChecks.join(', ')}`, 'error');
                updateDebug(`âœ… Passed: ${passedChecks.join(', ')}`, 'success');
            } else {
                updateDebug(`âœ… All ${Object.keys(checks).length} compatibility checks passed`, 'success');
            }
            
            // ãƒ¢ãƒã‚¤ãƒ«æœ€é©åŒ–é©ç”¨
            if (isMobile) {
                updateDebug(`Mobile optimizations applied for ${isIOS ? 'iOS' : 'Android'}`, 'info');
                
                // ãƒ¢ãƒã‚¤ãƒ«ç”¨ã®è¿½åŠ è¨­å®š
                document.body.style.touchAction = 'manipulation';
                document.body.style.userSelect = 'none';
                
                // iOS Safariç‰¹æœ‰ã®å•é¡Œå¯¾ç­–
                if (isIOS && isSafari) {
                    updateDebug("Applying iOS Safari specific fixes", 'info');
                    
                    // viewport meta tag å¼·åˆ¶æ›´æ–°
                    const viewport = document.querySelector('meta[name="viewport"]');
                    if (viewport) {
                        viewport.setAttribute('content', 
                            'width=device-width, initial-scale=1, shrink-to-fit=no, user-scalable=no, viewport-fit=cover'
                        );
                    }
                }
            }
            
            // WebGL ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆæƒ…å ±å–å¾—
            try {
                const canvas = document.createElement('canvas');
                const gl = canvas.getContext('webgl2') || canvas.getContext('webgl');
                if (gl) {
                    const renderer = gl.getParameter(gl.RENDERER);
                    const vendor = gl.getParameter(gl.VENDOR);
                    updateDebug(`GPU: ${renderer} (${vendor})`, 'info');
                }
            } catch (e) {
                updateDebug("Could not get WebGL context info", 'warning');
            }
            
            // A-Frame ã‚·ãƒ¼ãƒ³ã®åˆæœŸåŒ–ç›£è¦–
            const scene = document.querySelector('a-scene');
            if (scene) {
                scene.addEventListener('loaded', () => {
                    updateDebug("A-Frame scene loaded successfully", 'success');
                });
                
                scene.addEventListener('enter-vr', () => {
                    updateDebug("AR mode activated", 'success');
                });
                
                // AR.js ã®åˆæœŸåŒ–å®Œäº†ã‚’ç›£è¦–
                scene.addEventListener('arjs-video-loaded', (e) => {
                    updateDebug("AR.js video stream loaded", 'success');
                    arStarted = true;
                });
            }
        });
        
        // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–
        let performanceData = {
            frameDrops: 0,
            avgFPS: 0,
            fpsHistory: []
        };
        
        function monitorPerformance() {
            if (!arStarted) return;
            
            const now = performance.now();
            const timeDelta = now - (monitorPerformance.lastTime || now);
            monitorPerformance.lastTime = now;
            
            if (timeDelta > 0) {
                const currentFPS = 1000 / timeDelta;
                performanceData.fpsHistory.push(currentFPS);
                
                if (performanceData.fpsHistory.length > 30) {
                    performanceData.fpsHistory.shift();
                }
                
                performanceData.avgFPS = performanceData.fpsHistory.reduce((a, b) => a + b, 0) / performanceData.fpsHistory.length;
                
                if (currentFPS < 15) {
                    performanceData.frameDrops++;
                    if (performanceData.frameDrops % 10 === 0) {
                        updateDebug(`Performance warning: ${performanceData.frameDrops} frame drops, avg FPS: ${Math.round(performanceData.avgFPS)}`, 'warning');
                    }
                }
            }
            
            requestAnimationFrame(monitorPerformance);
        }
        
        // ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ç›£è¦–é–‹å§‹
        setTimeout(() => {
            if (arStarted) {
                monitorPerformance();
            }
        }, 5000);
        
        // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°å¼·åŒ–
        window.addEventListener('error', (e) => {
            updateDebug(`JS Error: ${e.message} at ${e.filename}:${e.lineno}`, 'error');
        });
        
        window.addEventListener('unhandledrejection', (e) => {
            updateDebug(`Unhandled Promise: ${e.reason}`, 'error');
        });
        
        // ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã®ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
        window.addEventListener('beforeunload', () => {
            if (cameraStarted) {
                updateDebug("Cleaning up resources...", 'info');
            }
        });
        
        // ãƒãƒ¼ã‚«ãƒ¼èªè­˜å“è³ªå‘ä¸Šã®ãŸã‚ã®è¿½åŠ å‡¦ç†
        function optimizeMarkerDetection() {
            // AR.js ã®è¨­å®šã‚’å‹•çš„ã«èª¿æ•´
            if (typeof ARjs !== 'undefined' && ARjs.Context) {
                updateDebug("Applying dynamic AR.js optimizations", 'info');
                
                // æ¤œå‡ºæ„Ÿåº¦ã‚’å‹•çš„èª¿æ•´
                const arContext = document.querySelector('a-scene').systems.arjs.data;
                if (arContext) {
                    // ã‚ˆã‚Šç©æ¥µçš„ãªæ¤œå‡ºè¨­å®š
                    arContext.maxDetectionRate = 120;
                    arContext.canvasWidth = Math.min(window.innerWidth, 1024);
                    arContext.canvasHeight = Math.min(window.innerHeight, 768);
                }
            }
            
            // ç…§æ˜æ¡ä»¶ã®æœ€é©åŒ–ææ¡ˆ
            if ('AmbientLightSensor' in window) {
                try {
                    const sensor = new AmbientLightSensor();
                    sensor.addEventListener('reading', () => {
                        const lux = sensor.illuminance;
                        if (lux < 100) {
                            updateDebug(`Low light detected (${Math.round(lux)} lux). Consider brighter lighting.`, 'warning');
                        } else if (lux > 10000) {
                            updateDebug(`Very bright light detected (${Math.round(lux)} lux). May cause glare.`, 'warning');
                        }
                    });
                    sensor.start();
                } catch (e) {
                    // Ambient light sensor not supported
                }
            }
        }
        
        // æœ€é©åŒ–ã‚’é…å»¶å®Ÿè¡Œ
        setTimeout(optimizeMarkerDetection, 2000);
        
        // ãƒ¦ãƒ¼ã‚¶ãƒ“ãƒªãƒ†ã‚£å‘ä¸Šï¼šãƒãƒ¼ã‚«ãƒ¼ã‚¬ã‚¤ãƒ€ãƒ³ã‚¹
        let guidanceTimer;
        function startGuidance() {
            if (guidanceTimer) clearInterval(guidanceTimer);
            
            let guidanceStep = 0;
            const guidanceMessages = [
                "ğŸ“± ãƒ‡ãƒã‚¤ã‚¹ã‚’æ°´å¹³ã«ä¿ã£ã¦ãã ã•ã„",
                "ğŸ’¡ ååˆ†ãªæ˜ã‚‹ã•ãŒã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„", 
                "ğŸ“ ãƒãƒ¼ã‚«ãƒ¼ã‹ã‚‰20-40cmç¨‹åº¦é›¢ã‚Œã¦ãã ã•ã„",
                "â¹ï¸ ãƒãƒ¼ã‚«ãƒ¼ã®å››è§’ãŒå®Œå…¨ã«ç”»é¢å†…ã«å…¥ã£ã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„",
                "ğŸ¯ ä¸­å¤®ã®ã‚¬ã‚¤ãƒ‰ã«ãƒãƒ¼ã‚«ãƒ¼ã‚’åˆã‚ã›ã¦ãã ã•ã„"
            ];
            
            guidanceTimer = setInterval(() => {
                if (!markerFound && arStarted) {
                    const message = guidanceMessages[guidanceStep % guidanceMessages.length];
                    
                    infoText.innerHTML = `
                        <div style="margin-bottom: 10px;">HIROãƒãƒ¼ã‚«ãƒ¼ã‚’æ¢ã—ã¦ã„ã¾ã™...</div>
                        <div style="font-size: 14px; color: #FFA500; margin-bottom: 8px;">${message}</div>
                        <div style="font-size: 12px; opacity: 0.7;">èªè­˜çŠ¶æ…‹: æ¤œç´¢ä¸­... (ãƒ’ãƒ³ãƒˆ ${guidanceStep + 1}/${guidanceMessages.length})</div>
                    `;
                    
                    guidanceStep++;
                }
            }, 5000);
        }
        
        // ã‚¬ã‚¤ãƒ€ãƒ³ã‚¹é–‹å§‹ï¼ˆARèµ·å‹•å¾Œï¼‰
        setTimeout(() => {
            if (arStarted && !markerFound) {
                startGuidance();
            }
        }, 8000);
