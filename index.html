<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no, user-scalable=no">
    <title>AR Stamp Rally</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.5/aframe/build/aframe-ar.js"></script>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: #000;
            overflow: hidden;
        }
        
        /* ã‚¹ãƒãƒ›ã§ã‚«ãƒ¡ãƒ©ãƒ•ã‚£ãƒ¼ãƒ‰ã‚’ç¢ºå®Ÿã«è¡¨ç¤º */
        #arjs-video {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            object-fit: cover !important;
            z-index: -1 !important;
        }
        
        /* A-Frameã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ç¢ºå®Ÿã«è¡¨ç¤º */
        .a-canvas {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            z-index: 1 !important;
        }
        
        #ui-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 999;
            pointer-events: none;
        }
        
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            pointer-events: all;
        }
        
        #startButton {
            background: #4CAF50;
            border: none;
            color: white;
            padding: 20px 40px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 18px;
            margin: 20px 2px;
            cursor: pointer;
            border-radius: 10px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            touch-action: manipulation;
        }
        
        #info {
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 15px;
            border-radius: 10px;
            font-size: 16px;
            text-align: center;
            pointer-events: none;
            border: 2px solid #4CAF50;
        }
        
        #debug {
            position: fixed;
            bottom: 20px;
            left: 20px;
            right: 20px;
            background: rgba(255, 0, 0, 0.8);
            color: white;
            padding: 10px;
            border-radius: 5px;
            font-size: 12px;
            pointer-events: none;
            max-height: 100px;
            overflow-y: auto;
        }
        
        /* ãƒãƒ¼ã‚«ãƒ¼èªè­˜å¼·åŒ–ç”¨ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
        #marker-overlay {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 300px;
            height: 300px;
            border: 3px dashed #4CAF50;
            border-radius: 10px;
            pointer-events: none;
            z-index: 100;
        }
        
        #marker-overlay::after {
            content: "HIROãƒãƒ¼ã‚«ãƒ¼ã‚’ã“ã“ã«";
            position: absolute;
            top: -40px;
            left: 50%;
            transform: translateX(-50%);
            color: #4CAF50;
            font-size: 14px;
            background: rgba(0,0,0,0.8);
            padding: 5px 10px;
            border-radius: 5px;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* ã‚¹ãƒãƒ›ç”¨ã®å¼·åˆ¶è¡¨ç¤º */
        @media (max-width: 768px) {
            #arjs-video, .a-canvas {
                -webkit-transform: translateZ(0) !important;
                transform: translateZ(0) !important;
                -webkit-backface-visibility: hidden !important;
                backface-visibility: hidden !important;
                will-change: transform !important;
            }
        }
        
    </style>
</head>
<body>
    <div id="ui-overlay">
        <div id="loading">
            <h1>ğŸ¯ AR ã‚¹ã‚¿ãƒ³ãƒ—ãƒ©ãƒªãƒ¼</h1>
            <p id="status">ã‚¿ãƒƒãƒ—ã—ã¦é–‹å§‹</p>
            <button id="startButton">ğŸ“· ã‚«ãƒ¡ãƒ©ã‚’é–‹å§‹</button>
            <div style="margin-top: 20px; font-size: 14px; opacity: 0.8;">
                <p>HIROãƒãƒ¼ã‚«ãƒ¼èªè­˜ã®ã‚³ãƒ„ï¼š</p>
                <p>â€¢ æ˜ã‚‹ã„å ´æ‰€ã§ä½¿ç”¨</p>
                <p>â€¢ ãƒãƒ¼ã‚«ãƒ¼ã‚’å¹³ã‚‰ã«ç½®ã</p>
                <p>â€¢ 30cmç¨‹åº¦ã®è·é›¢ã‚’ä¿ã¤</p>
                <a href="https://github.com/AR-js-org/AR.js/blob/master/data/images/hiro.png" target="_blank" style="color: #4CAF50;">
                    ğŸ“¥ HIROãƒãƒ¼ã‚«ãƒ¼ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                </a>
            </div>
        </div>
        
        <div id="info" class="hidden">
            <div id="info-text">ARã‚«ãƒ¡ãƒ©èµ·å‹•ä¸­...</div>
        </div>
        
        <div id="marker-overlay" class="hidden"></div>
        
        <div id="debug" class="hidden">
            <div id="debug-text">Debug info</div>
        </div>
    </div>

    <!-- AR Scene - ãƒãƒ¼ã‚«ãƒ¼èªè­˜ã‚’å¼·åŒ– -->
    <a-scene
        embedded
        arjs="sourceType: webcam; trackingMethod: best; debugUIEnabled: false; detectionMode: mono_and_matrix; matrixCodeType: 3x3; labelingMode: black_region; patternRatio: 0.8; maxDetectionRate: 60; canvasWidth: 640; canvasHeight: 480;"
        vr-mode-ui="enabled: false"
        device-orientation-permission-ui="enabled: false"
        loading-screen="enabled: false"
        inspector="url: false"
        keyboard-shortcuts="enabled: false"
        screenshot="enabled: false"
        renderer="logarithmicDepthBuffer: true; colorManagement: true; sortObjects: true; antialias: true; alpha: true;"
        background="transparent: true"
        style="z-index: 1;">
        
        <!-- ãƒãƒ¼ã‚«ãƒ¼èªè­˜ã‚’å¼·åŒ–ã—ãŸHIROãƒãƒ¼ã‚«ãƒ¼ -->
        <a-marker 
            preset="hiro" 
            id="hiro-marker"
            smooth="true"
            smoothCount="5"
            smoothTolerance="0.01"
            smoothThreshold="2"
            raycaster="objects: .clickable"
            cursor="fuse: false; rayOrigin: mouse;">
            
            <!-- ã‚ˆã‚Šç›®ç«‹ã¤3Dã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ -->
            <a-box 
                position="0 0.5 0" 
                scale="0.8 0.8 0.8"
                color="#FFD700"
                metalness="0.1"
                roughness="0.3"
                animation="property: rotation; to: 0 360 0; loop: true; dur: 4000"
                shadow="cast: true; receive: false;">
            </a-box>
            
            <!-- å›è»¢ã™ã‚‹è£…é£¾ãƒªãƒ³ã‚° -->
            <a-torus 
                position="0 0.5 0" 
                color="#FF4444" 
                radius="0.8" 
                radius-tubular="0.1"
                animation="property: rotation; to: 360 0 0; loop: true; dur: 2000">
            </a-torus>
            
            <!-- å¤§ããã¦ç›®ç«‹ã¤ãƒ†ã‚­ã‚¹ãƒˆ -->
            <a-text 
                value="ğŸ‰ STAMP! ğŸ‰"
                position="0 1.5 0"
                align="center"
                color="#FF0000"
                scale="3 3 3"
                font="kframe"
                animation="property: scale; to: 3.5 3.5 3.5; dir: alternate; loop: true; dur: 1000">
            </a-text>
            
            <!-- ç™ºå…‰ã‚¨ãƒ•ã‚§ã‚¯ãƒˆç”¨ã®çƒä½“ -->
            <a-sphere 
                position="0 2 0" 
                radius="0.2" 
                color="#FFFF00"
                material="emissive: #FFFF00; emissiveIntensity: 0.5"
                animation="property: position; to: 0 2.5 0; dir: alternate; loop: true; dur: 1500">
            </a-sphere>
            
            <!-- åœŸå°ï¼ˆå½±ã‚’å—ã‘ã‚‹ï¼‰ -->
            <a-cylinder 
                position="0 0 0" 
                radius="1.2" 
                height="0.1" 
                color="#8B4513"
                shadow="receive: true; cast: false">
            </a-cylinder>
            
        </a-marker>
        
        <a-entity 
            camera 
            look-controls-enabled="false"
            wasd-controls-enabled="false">
        </a-entity>
    </a-scene>

    <script>
        const startButton = document.getElementById('startButton');
        const loading = document.getElementById('loading');
        const info = document.getElementById('info');
        const status = document.getElementById('status');
        const infoText = document.getElementById('info-text');
        const debug = document.getElementById('debug');
        const debugText = document.getElementById('debug-text');
        const markerOverlay = document.getElementById('marker-overlay');
        
        let cameraStarted = false;
        let arStarted = false;
        let markerFound = false;
        let debugLog = [];
        
        // ãƒ‡ãƒãƒƒã‚°æƒ…å ±è¡¨ç¤º
        function updateDebug(message) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `${timestamp}: ${message}`;
            console.log("ğŸ” " + logEntry);
            
            debugLog.push(logEntry);
            if (debugLog.length > 10) debugLog.shift(); // æœ€æ–°10ä»¶ã®ã¿ä¿æŒ
            
            debugText.innerHTML = debugLog.join('<br>');
            debug.classList.remove('hidden');
        }
        
        // ãƒ‡ãƒã‚¤ã‚¹æ¤œå‡º
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        const isAndroid = /Android/.test(navigator.userAgent);
        const isSafari = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);
        const isMobile = isIOS || isAndroid;
        
        updateDebug(`Device: ${isIOS ? 'iOS' : isAndroid ? 'Android' : 'Desktop'} ${isSafari ? 'Safari' : 'Other'}`);
        
        // ã‚¹ãƒãƒ›ç”¨ã®å¼·åˆ¶ã‚«ãƒ¡ãƒ©è¡¨ç¤º
        function forceVideoDisplay() {
            updateDebug("Forcing video display for mobile...");
            
            // AR.jsã®ãƒ“ãƒ‡ã‚ªè¦ç´ ã‚’æ¢ã—ã¦å¼·åˆ¶è¡¨ç¤º
            const checkVideo = setInterval(() => {
                const video = document.querySelector('#arjs-video') || document.querySelector('video');
                if (video) {
                    updateDebug("Found video element, applying mobile styles");
                    
                    video.style.position = 'fixed';
                    video.style.top = '0';
                    video.style.left = '0';
                    video.style.width = '100%';
                    video.style.height = '100%';
                    video.style.objectFit = 'cover';
                    video.style.zIndex = '-1';
                    video.style.transform = 'translateZ(0)';
                    video.style.webkitTransform = 'translateZ(0)';
                    video.style.backfaceVisibility = 'hidden';
                    video.style.webkitBackfaceVisibility = 'hidden';
                    
                    // ã‚¹ãƒãƒ›ã®å ´åˆã€ãƒ“ãƒ‡ã‚ªã®å¯è¦–æ€§ã‚’å¼·åˆ¶
                    if (isMobile) {
                        video.style.visibility = 'visible';
                        video.style.opacity = '1';
                        video.style.display = 'block';
                        updateDebug("Applied mobile video visibility fixes");
                    }
                    
                    clearInterval(checkVideo);
                }
            }, 100);
            
            // 10ç§’å¾Œã«ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ
            setTimeout(() => clearInterval(checkVideo), 10000);
        }
        
        startButton.addEventListener('click', async function() {
            updateDebug("Start button clicked");
            status.textContent = "ã‚«ãƒ¡ãƒ©ã«ã‚¢ã‚¯ã‚»ã‚¹ä¸­...";
            
            try {
                // Step 1: ã‚«ãƒ¡ãƒ©è¨±å¯ã‚’å–å¾—
                updateDebug("Requesting camera access...");
                
                const constraints = {
                    video: {
                        facingMode: { ideal: 'environment' },
                        width: { ideal: 640, max: 1280 },
                        height: { ideal: 480, max: 720 }
                    }
                };
                
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                updateDebug(`Camera stream obtained: ${stream.getVideoTracks().length} tracks`);
                
                // ã‚¹ãƒˆãƒªãƒ¼ãƒ æƒ…å ±ã‚’ãƒ­ã‚°
                const track = stream.getVideoTracks()[0];
                const settings = track.getSettings();
                updateDebug(`Video: ${settings.width}x${settings.height}, facing: ${settings.facingMode}`);
                
                // ã™ãã«ã‚¹ãƒˆãƒªãƒ¼ãƒ ã‚’åœæ­¢ï¼ˆAR.jsãŒç‹¬è‡ªã«ç®¡ç†ã™ã‚‹ãŸã‚ï¼‰
                stream.getTracks().forEach(track => track.stop());
                cameraStarted = true;
                
                // Step 2: UIã‚’åˆ‡ã‚Šæ›¿ãˆ
                status.textContent = "ARã‚’åˆæœŸåŒ–ä¸­...";
                updateDebug("Starting AR initialization...");
                
                // ã‚¹ãƒãƒ›ç”¨ã®å¼·åˆ¶ãƒ“ãƒ‡ã‚ªè¡¨ç¤ºã‚’é–‹å§‹
                if (isMobile) {
                    forceVideoDisplay();
                }
                
                // ãƒ‡ãƒã‚¤ã‚¹åˆ¥å¾…æ©Ÿæ™‚é–“
                const waitTime = isMobile ? (isIOS ? 5000 : 4000) : 2000;
                updateDebug(`Waiting ${waitTime}ms for AR initialization...`);
                
                setTimeout(() => {
                    loading.classList.add('hidden');
                    info.classList.remove('hidden');
                    markerOverlay.classList.remove('hidden');
                    infoText.textContent = "HIROãƒãƒ¼ã‚«ãƒ¼ã‚’ä¸­å¤®ã®ã‚¬ã‚¤ãƒ‰ã«åˆã‚ã›ã¦ãã ã•ã„";
                    
                    updateDebug("UI switched, setting up AR listeners...");
                    
                    // Step 3: ARã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
                    setupARListeners();
                    
                    // Step 4: ARãŒå®Ÿéš›ã«å‹•ä½œã—ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
                    setTimeout(checkARStatus, 3000);
                    
                }, waitTime);
                
            } catch (error) {
                updateDebug(`Camera error: ${error.name} - ${error.message}`);
                handleCameraError(error);
            }
        });
        
        function setupARListeners() {
            const marker = document.getElementById('hiro-marker');
            const scene = document.querySelector('a-scene');
            
            if (marker) {
                marker.addEventListener('markerFound', function() {
                    updateDebug("ğŸ‰ HIRO marker FOUND!");
                    markerFound = true;
                    infoText.innerHTML = `
                        <div style="color: #00FF00; font-size: 20px;">ğŸ‰ ã‚¹ã‚¿ãƒ³ãƒ—ç™ºè¦‹ï¼</div>
                        <div>ãƒãƒ¼ã‚«ãƒ¼ã‚’å®‰å®šã—ã¦ä¿æŒã—ã¦ãã ã•ã„</div>
                    `;
                    info.style.borderColor = "#00FF00";
                    markerOverlay.style.borderColor = "#00FF00";
                    markerOverlay.style.boxShadow = "0 0 20px #00FF00";
                });
                
                marker.addEventListener('markerLost', function() {
                    updateDebug("âŒ HIRO marker lost");
                    markerFound = false;
                    infoText.innerHTML = `
                        <div>HIROãƒãƒ¼ã‚«ãƒ¼ã‚’ä¸­å¤®ã®ã‚¬ã‚¤ãƒ‰ã«åˆã‚ã›ã¦ãã ã•ã„</div>
                        <div style="font-size: 12px; margin-top: 5px;">æ˜ã‚‹ã„å ´æ‰€ã§ã€30cmç¨‹åº¦ã®è·é›¢ã‚’ä¿ã£ã¦ãã ã•ã„</div>
                    `;
                    info.style.borderColor = "#4CAF50";
                    markerOverlay.style.borderColor = "#4CAF50";
                    markerOverlay.style.boxShadow = "none";
                });
            }
            
            if (scene) {
                scene.addEventListener('arjs-video-loaded', function() {
                    updateDebug("ğŸ“¹ AR.js video loaded successfully!");
                    arStarted = true;
                });
                
                scene.addEventListener('camera-init', function() {
                    updateDebug("ğŸ“· Camera initialized by AR.js");
                });
                
                // ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°é–‹å§‹ã‚’æ¤œå‡º
                scene.addEventListener('renderstart', function() {
                    updateDebug("ğŸ® AR scene render started");
                });
            }
        }
        
        function checkARStatus() {
            const scene = document.querySelector('a-scene');
            const canvas = scene ? scene.canvas : null;
            const video = document.querySelector('#arjs-video') || document.querySelector('video');
            
            updateDebug(`Status check - Scene: ${!!scene}, Canvas: ${!!canvas}, Video: ${!!video}, Started: ${arStarted}`);
            
            if (!arStarted && !video) {
                updateDebug("âš ï¸ AR not properly initialized, trying recovery...");
                infoText.innerHTML = `
                    <div style="color: #FFA500;">ARã®åˆæœŸåŒ–ã«æ™‚é–“ãŒã‹ã‹ã£ã¦ã„ã¾ã™...</div>
                    <div style="font-size: 12px; margin-top: 10px;">
                        ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚æ”¹å–„ã•ã‚Œãªã„å ´åˆã¯ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚
                    </div>
                `;
                
                // ã•ã‚‰ã«æ™‚é–“ã‚’å¾…ã¤
                setTimeout(() => {
                    if (!arStarted) {
                        updateDebug("â— AR initialization timeout");
                        infoText.innerHTML = `
                            <div style="color: #FF4444;">ARã®åˆæœŸåŒ–ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ</div>
                            <div style="font-size: 12px; margin-top: 10px;">
                                <button onclick="location.reload()" style="padding: 8px 16px; background: #4CAF50; color: white; border: none; border-radius: 5px;">
                                    ğŸ”„ å†èª­ã¿è¾¼ã¿
                                </button>
                            </div>
                        `;
                    }
                }, 8000);
            } else {
                updateDebug("âœ… AR appears to be working");
                infoText.innerHTML = `
                    <div>HIROãƒãƒ¼ã‚«ãƒ¼ã‚’ä¸­å¤®ã®ã‚¬ã‚¤ãƒ‰ã«åˆã‚ã›ã¦ãã ã•ã„</div>
                    <div style="font-size: 12px; margin-top: 5px; color: #00FF00;">
                        ARã‚«ãƒ¡ãƒ©ãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã¾ã™
                    </div>
                `;
            }
        }
        
        function handleCameraError(error) {
            let errorMessage = "ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ";
            let solution = "";
            
            switch (error.name) {
                case 'NotAllowedError':
                    errorMessage = "ã‚«ãƒ¡ãƒ©ã®è¨±å¯ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ";
                    solution = "ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã§ã‚«ãƒ¡ãƒ©ã‚’è¨±å¯ã—ã¦ãã ã•ã„";
                    break;
                case 'NotFoundError':
                    errorMessage = "ã‚«ãƒ¡ãƒ©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“";
                    solution = "ãƒ‡ãƒã‚¤ã‚¹ã«ã‚«ãƒ¡ãƒ©ãŒã‚ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„";
                    break;
                case 'NotSupportedError':
                    errorMessage = "ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯ã‚«ãƒ¡ãƒ©ã‚’ã‚µãƒãƒ¼ãƒˆã—ã¦ã„ã¾ã›ã‚“";
                    solution = "Chromeã€Firefoxã€Safariã‚’ãŠè©¦ã—ãã ã•ã„";
                    break;
                case 'OverconstrainedError':
                    errorMessage = "ã‚«ãƒ¡ãƒ©ã®è¨­å®šã«å•é¡ŒãŒã‚ã‚Šã¾ã™";
                    solution = "åˆ¥ã®ã‚«ãƒ¡ãƒ©ã¾ãŸã¯ãƒ–ãƒ©ã‚¦ã‚¶ã‚’ãŠè©¦ã—ãã ã•ã„";
                    break;
            }
            
            status.innerHTML = `
                <div style="color: #ff4444; margin-bottom: 10px;">${errorMessage}</div>
                <div style="font-size: 14px; margin-bottom: 15px;">${solution}</div>
                <button onclick="location.reload()" style="padding: 10px 20px; background: #4CAF50; color: white; border: none; border-radius: 5px;">
                    ğŸ”„ å†èª­ã¿è¾¼ã¿
                </button>
            `;
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®ãƒã‚§ãƒƒã‚¯
        window.addEventListener('load', () => {
            updateDebug("Page loaded, running compatibility checks...");
            
            const checks = {
                'HTTPS': location.protocol === 'https:',
                'MediaDevices': 'mediaDevices' in navigator,
                'getUserMedia': navigator.mediaDevices && 'getUserMedia' in navigator.mediaDevices,
                'WebGL': !!window.WebGLRenderingContext,
                'A-Frame': typeof AFRAME !== 'undefined'
            };
            
            const failedChecks = Object.entries(checks).filter(([key, value]) => !value).map(([key]) => key);
            
            if (failedChecks.length > 0) {
                updateDebug(`âŒ Failed checks: ${failedChecks.join(', ')}`);
            } else {
                updateDebug("âœ… All compatibility checks passed");
            }
            
            // ã‚¹ãƒãƒ›ã§ã®è¿½åŠ ãƒã‚§ãƒƒã‚¯
            if (isMobile) {
                updateDebug(`Mobile device detected - applying mobile optimizations`);
            }
        });
        
    </script>
</body>
</html>
