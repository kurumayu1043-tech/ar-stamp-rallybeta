<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>AR Stamp Rally</title>
    <script src="https://cdn.jsdelivr.net/gh/aframevr/aframe@1.5.0/dist/aframe-master.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/dist/mind-ar-aframe.prod.js"></script>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
        }
        
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        #startButton {
            background: #4CAF50;
            border: none;
            color: white;
            padding: 15px 32px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 8px;
        }
        
        #info {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            z-index: 100;
            font-size: 14px;
        }
        
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div id="loading">
        <h2>AR „Çπ„Çø„É≥„Éó„É©„É™„Éº</h2>
        <p>„Ç´„É°„É©„ÅÆ„Ç¢„ÇØ„Çª„ÇπË®±ÂèØ„ÅåÂøÖË¶Å„Åß„Åô</p>
        <button id="startButton">ÈñãÂßã</button>
        <div id="status">Ê∫ñÂÇô‰∏≠...</div>
    </div>
    
    <div id="info" class="hidden">
        <div>AR„Éû„Éº„Ç´„Éº„ÇíÊé¢„Åó„Å¶„Åè„Å†„Åï„ÅÑ</div>
        <div id="found" class="hidden">„Çπ„Çø„É≥„Éó„ÇíÁô∫Ë¶ãÔºÅ</div>
    </div>
    
    <a-scene 
        mindar-image="imageTargetSrc: https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/card-example/card.mind; autoStart: false; uiLoading: no; uiScanning: no; uiError: no;"
        color-space="sRGB"
        renderer="colorManagement: true, physicallyCorrectLights"
        vr-mode-ui="enabled: false"
        device-orientation-permission-ui="enabled: false"
        embedded
        style="position: fixed; top: 0; left: 0; width: 100%; height: 100%;">
        
        <a-assets>
            <a-asset-item id="avatarModel" src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/card-example/softmind/scene.gltf"></a-asset-item>
        </a-assets>
        
        <a-camera 
            position="0 0 0" 
            look-controls="enabled: false" 
            cursor="fuse: false; rayOrigin: mouse;"
            raycaster="far: ${customFields.libVersion}; objects: .clickable">
        </a-camera>
        
        <!-- AR Target Entity -->
        <a-entity mindar-image-target="targetIndex: 0">
            <!-- 3D Model -->
            <a-gltf-model 
                gltf-model="#avatarModel"
                scale="0.3 0.3 0.3"
                position="0 0 0"
                rotation="0 0 0"
                animation-mixer
                visible="true">
            </a-gltf-model>
            
            <!-- Success Message -->
            <a-text 
                value="„Çπ„Çø„É≥„ÉóGET!"
                position="0 0.5 0"
                align="center"
                color="red"
                scale="2 2 2"
                visible="true">
            </a-text>
            
            <!-- Celebration Animation -->
            <a-box 
                position="0 0.3 0" 
                scale="0.1 0.1 0.1" 
                color="gold"
                animation="property: rotation; to: 0 360 0; loop: true; dur: 2000"
                visible="true">
            </a-box>
        </a-entity>
    </a-scene>

    <script>
        const startButton = document.querySelector("#startButton");
        const loading = document.querySelector("#loading");
        const info = document.querySelector("#info");
        const status = document.querySelector("#status");
        const found = document.querySelector("#found");
        
        let sceneEl;
        let arSystem;
        
        startButton.addEventListener('click', async () => {
            try {
                status.textContent = "„Ç´„É°„É©„ÇíÂàùÊúüÂåñ‰∏≠...";
                
                // Get camera permission first
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                });
                
                // Stop the stream immediately - MindAR will handle it
                stream.getTracks().forEach(track => track.stop());
                
                status.textContent = "AR„ÇíÂàùÊúüÂåñ‰∏≠...";
                
                // Initialize A-Frame scene
                sceneEl = document.querySelector('a-scene');
                
                // Wait for A-Frame to load
                if (sceneEl.hasLoaded) {
                    initAR();
                } else {
                    sceneEl.addEventListener('loaded', initAR);
                }
                
            } catch (error) {
                console.error('Error accessing camera:', error);
                status.textContent = `„Ç®„É©„Éº: ${error.message}`;
                
                if (error.name === 'NotAllowedError') {
                    status.innerHTML = `
                        <div>„Ç´„É°„É©„ÅÆ„Ç¢„ÇØ„Çª„ÇπË®±ÂèØ„ÅåÊãíÂê¶„Åï„Çå„Åæ„Åó„Åü</div>
                        <div style="font-size: 12px; margin-top: 10px;">
                            „Éñ„É©„Ç¶„Ç∂„ÅÆË®≠ÂÆö„Åß„Ç´„É°„É©„ÇíË®±ÂèØ„Åó„Å¶„Åè„Å†„Åï„ÅÑ
                        </div>
                    `;
                } else if (error.name === 'NotFoundError') {
                    status.textContent = "„Ç´„É°„É©„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì";
                } else {
                    status.textContent = "„Ç´„É°„É©„ÅÆÂàùÊúüÂåñ„Å´Â§±Êïó„Åó„Åæ„Åó„Åü";
                }
            }
        });
        
        function initAR() {
            try {
                arSystem = sceneEl.systems["mindar-image-system"];
                
                arSystem.start().then(() => {
                    console.log("MindAR started successfully");
                    loading.classList.add("hidden");
                    info.classList.remove("hidden");
                    
                    // Add target found/lost event listeners
                    const target = document.querySelector('[mindar-image-target]');
                    
                    target.addEventListener('targetFound', event => {
                        console.log("Target found", event.detail.targetIndex);
                        found.classList.remove("hidden");
                        
                        // Add celebration effect
                        setTimeout(() => {
                            alert("„Çπ„Çø„É≥„Éó„ÇíÁç≤Âæó„Åó„Åæ„Åó„ÅüÔºÅüéâ");
                        }, 1000);
                    });
                    
                    target.addEventListener('targetLost', event => {
                        console.log("Target lost", event.detail.targetIndex);
                        found.classList.add("hidden");
                    });
                    
                }).catch(error => {
                    console.error("Failed to start MindAR:", error);
                    status.textContent = `ARÂàùÊúüÂåñ„Ç®„É©„Éº: ${error.message}`;
                });
                
            } catch (error) {
                console.error("Error in initAR:", error);
                status.textContent = `ÂàùÊúüÂåñ„Ç®„É©„Éº: ${error.message}`;
            }
        }
        
        // Handle page visibility changes
        document.addEventListener('visibilitychange', () => {
            if (!arSystem) return;
            
            if (document.visibilityState === 'visible') {
                arSystem.start();
            } else {
                arSystem.stop();
            }
        });
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (arSystem) {
                arSystem.stop();
            }
        });
        
        // Debug information
        console.log("User Agent:", navigator.userAgent);
        console.log("HTTPS:", location.protocol === 'https:');
        console.log("Camera API available:", 'mediaDevices' in navigator);
        
    </script>
</body>
</html>
