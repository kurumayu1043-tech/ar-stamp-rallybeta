<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>AR Stamp Rally</title>
    <script src="https://cdn.jsdelivr.net/gh/aframevr/aframe@1.5.0/dist/aframe-master.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/dist/mind-ar-aframe.prod.js"></script>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
        }
        
        #loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        #startButton {
            background: #4CAF50;
            border: none;
            color: white;
            padding: 15px 32px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 8px;
        }
        
        #info {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 10px;
            border-radius: 5px;
            z-index: 100;
            font-size: 14px;
        }
        
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div id="loading">
        <h2>AR ã‚¹ã‚¿ãƒ³ãƒ—ãƒ©ãƒªãƒ¼</h2>
        <p>ã‚«ãƒ¡ãƒ©ã®ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ãŒå¿…è¦ã§ã™</p>
        <button id="startButton">é–‹å§‹</button>
        <div id="status">æº–å‚™ä¸­...</div>
    </div>
    
    <div id="info" class="hidden">
        <div>ARãƒãƒ¼ã‚«ãƒ¼ã‚’æ¢ã—ã¦ãã ã•ã„</div>
        <div id="found" class="hidden">ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ç™ºè¦‹ï¼</div>
    </div>
    
    <a-scene id="scene"
        embedded
        style="position: fixed; top: 0; left: 0; width: 100%; height: 100%;"
        vr-mode-ui="enabled: false"
        device-orientation-permission-ui="enabled: false"
        loading-screen="enabled: false"
        renderer="colorManagement: true, physicallyCorrectLights: true, alpha: true, antialias: true"
        background="color: #000; transparent: true">
        
        <a-assets timeout="30000">
            <a-asset-item id="avatarModel" src="https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/card-example/softmind/scene.gltf"></a-asset-item>
        </a-assets>
        
        <a-camera 
            position="0 0 0" 
            look-controls="enabled: false">
        </a-camera>
        
        <!-- This will be dynamically populated -->
        <a-entity id="ar-content"></a-entity>
    </a-scene>

    <script>
        const startButton = document.querySelector("#startButton");
        const loading = document.querySelector("#loading");
        const info = document.querySelector("#info");
        const status = document.querySelector("#status");
        const found = document.querySelector("#found");
        const sceneEl = document.querySelector("#scene");
        const arContent = document.querySelector("#ar-content");
        
        let mindARInstance = null;
        let isARStarted = false;
        
        // Wait for libraries to load completely
        function waitForLibraries() {
            return new Promise((resolve, reject) => {
                let attempts = 0;
                const maxAttempts = 50;
                
                function check() {
                    attempts++;
                    console.log(`Library check attempt ${attempts}`);
                    
                    if (window.AFRAME && window.MINDAR) {
                        console.log("Libraries loaded successfully");
                        resolve();
                    } else if (attempts >= maxAttempts) {
                        reject(new Error("Libraries failed to load"));
                    } else {
                        setTimeout(check, 200);
                    }
                }
                check();
            });
        }
        
        startButton.addEventListener('click', async () => {
            try {
                status.textContent = "ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚’ç¢ºèªä¸­...";
                
                // Wait for libraries to load
                await waitForLibraries();
                
                status.textContent = "ã‚«ãƒ¡ãƒ©ã‚’åˆæœŸåŒ–ä¸­...";
                
                // Get camera permission first
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                });
                
                // Stop the stream - MindAR will handle camera
                stream.getTracks().forEach(track => track.stop());
                
                status.textContent = "ARã‚’åˆæœŸåŒ–ä¸­...";
                
                // Initialize with direct MindAR approach
                await initMindAR();
                
            } catch (error) {
                console.error('Initialization error:', error);
                handleError(error);
            }
        });
        
        async function initMindAR() {
            try {
                // Create MindAR instance directly
                const { MindARThree } = window.MINDAR.IMAGE;
                
                mindARInstance = new MindARThree({
                    container: sceneEl,
                    imageTargetSrc: 'https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/card-example/card.mind',
                    maxTrack: 1,
                    uiLoading: "no",
                    uiScanning: "no",
                    uiError: "no"
                });
                
                console.log("MindAR instance created");
                
                // Start the AR system
                await mindARInstance.start();
                console.log("MindAR started successfully");
                
                isARStarted = true;
                loading.classList.add("hidden");
                info.classList.remove("hidden");
                
                // Setup 3D content
                setupARContent();
                
            } catch (error) {
                console.error("MindAR initialization failed:", error);
                
                // Fallback to A-Frame component approach
                try {
                    await initWithAFrameComponent();
                } catch (fallbackError) {
                    console.error("Fallback initialization also failed:", fallbackError);
                    throw new Error(`AR initialization failed: ${error.message}`);
                }
            }
        }
        
        async function initWithAFrameComponent() {
            console.log("Trying A-Frame component fallback");
            
            // Remove existing content
            arContent.innerHTML = '';
            
            // Add MindAR component to scene
            sceneEl.setAttribute('mindar-image', {
                imageTargetSrc: 'https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/card-example/card.mind',
                autoStart: false,
                uiLoading: 'no',
                uiScanning: 'no',
                uiError: 'no',
                maxTrack: 1
            });
            
            // Wait for component to initialize
            await new Promise(resolve => {
                setTimeout(resolve, 3000);
            });
            
            // Try to start the system
            const system = sceneEl.systems['mindar-image-system'];
            if (system && system.start) {
                await system.start();
                console.log("A-Frame component started");
            }
            
            // Add AR content using A-Frame approach
            setupAFrameARContent();
            
            isARStarted = true;
            loading.classList.add("hidden");
            info.classList.remove("hidden");
        }
        
        function setupARContent() {
            if (!mindARInstance) return;
            
            // Get the anchor for target 0
            const anchor = mindARInstance.addAnchor(0);
            
            // Create 3D content using Three.js
            const geometry = new THREE.BoxGeometry(0.1, 0.1, 0.1);
            const material = new THREE.MeshBasicMaterial({ color: 0xffd700 });
            const cube = new THREE.Mesh(geometry, material);
            
            // Add rotation animation
            const animate = () => {
                cube.rotation.x += 0.01;
                cube.rotation.y += 0.01;
                requestAnimationFrame(animate);
            };
            animate();
            
            anchor.group.add(cube);
            
            // Handle anchor events
            anchor.onTargetFound = () => {
                console.log("Target found via MindAR");
                found.classList.remove("hidden");
                setTimeout(() => {
                    alert("ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ç²å¾—ã—ã¾ã—ãŸï¼ğŸ‰");
                }, 1000);
            };
            
            anchor.onTargetLost = () => {
                console.log("Target lost via MindAR");
                found.classList.add("hidden");
            };
        }
        
        function setupAFrameARContent() {
            // Create A-Frame AR content
            arContent.innerHTML = `
                <a-entity mindar-image-target="targetIndex: 0">
                    <a-gltf-model 
                        gltf-model="#avatarModel"
                        scale="0.3 0.3 0.3"
                        position="0 0 0"
                        rotation="0 0 0"
                        animation-mixer
                        visible="true">
                    </a-gltf-model>
                    
                    <a-text 
                        value="ã‚¹ã‚¿ãƒ³ãƒ—GET!"
                        position="0 0.5 0"
                        align="center"
                        color="red"
                        scale="2 2 2"
                        visible="true">
                    </a-text>
                    
                    <a-box 
                        position="0 0.3 0" 
                        scale="0.1 0.1 0.1" 
                        color="gold"
                        animation="property: rotation; to: 0 360 0; loop: true; dur: 2000"
                        visible="true">
                    </a-box>
                </a-entity>
            `;
            
            // Wait for content to be added to DOM
            setTimeout(() => {
                const target = arContent.querySelector('[mindar-image-target]');
                if (target) {
                    target.addEventListener('targetFound', event => {
                        console.log("Target found via A-Frame", event.detail.targetIndex);
                        found.classList.remove("hidden");
                        setTimeout(() => {
                            alert("ã‚¹ã‚¿ãƒ³ãƒ—ã‚’ç²å¾—ã—ã¾ã—ãŸï¼ğŸ‰");
                        }, 1000);
                    });
                    
                    target.addEventListener('targetLost', event => {
                        console.log("Target lost via A-Frame", event.detail.targetIndex);
                        found.classList.add("hidden");
                    });
                }
            }, 1000);
        }
        
        function handleError(error) {
            console.error('Error details:', error);
            
            if (error.name === 'NotAllowedError') {
                status.innerHTML = `
                    <div>ã‚«ãƒ¡ãƒ©ã®ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ</div>
                    <div style="font-size: 12px; margin-top: 10px;">
                        ãƒ–ãƒ©ã‚¦ã‚¶ã®è¨­å®šã§ã‚«ãƒ¡ãƒ©ã‚’è¨±å¯ã—ã¦ãã ã•ã„
                    </div>
                `;
            } else if (error.name === 'NotFoundError') {
                status.textContent = "ã‚«ãƒ¡ãƒ©ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“";
            } else if (error.message.includes('Libraries failed to load')) {
                status.innerHTML = `
                    <div>å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ</div>
                    <div style="font-size: 12px; margin-top: 10px;">
                        ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„
                    </div>
                    <button onclick="location.reload()" style="margin-top: 10px; padding: 5px 10px;">
                        å†èª­ã¿è¾¼ã¿
                    </button>
                `;
            } else {
                status.innerHTML = `
                    <div>åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ${error.message}</div>
                    <div style="font-size: 12px; margin-top: 10px;">
                        ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„
                    </div>
                    <button onclick="location.reload()" style="margin-top: 10px; padding: 5px 10px;">
                        å†èª­ã¿è¾¼ã¿
                    </button>
                `;
            }
        }
        
        // Handle page visibility changes
        document.addEventListener('visibilitychange', () => {
            if (!isARStarted) return;
            
            if (document.visibilityState === 'visible') {
                if (mindARInstance && mindARInstance.start) {
                    mindARInstance.start().catch(console.error);
                }
            } else {
                if (mindARInstance && mindARInstance.stop) {
                    mindARInstance.stop();
                }
            }
        });
        
        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            if (mindARInstance && mindARInstance.stop) {
                mindARInstance.stop();
            }
        });
        
        // Debug information
        console.log("User Agent:", navigator.userAgent);
        console.log("HTTPS:", location.protocol === 'https:');
        console.log("Camera API available:", 'mediaDevices' in navigator);
        
        // Check if libraries are loading
        setTimeout(() => {
            console.log("AFRAME available:", !!window.AFRAME);
            console.log("MINDAR available:", !!window.MINDAR);
        }, 1000);
        
    </script>
</body>
</html>
