<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no, user-scalable=no">
    <title>ÊñáÂåñÁ•≠ AR„Çπ„Çø„É≥„Éó„É©„É™„Éº</title>
    <!-- A-Frame„É©„Ç§„Éñ„É©„É™„ÇíCDN„Åã„ÇâË™≠„ÅøËæº„Åø -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <style>
        /* Base styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            overflow: hidden;
            height: 100vh;
        }

        #app {
            position: relative;
            width: 100%;
            height: 100vh;
        }

        /* „Çπ„Çø„Éº„ÉàÁîªÈù¢ */
        #start-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
            transition: opacity 0.5s ease-in-out;
            z-index: 10;
        }

        #start-screen h1 {
            font-size: 2.5rem;
            margin-bottom: 20px;
        }

        #start-screen p {
            font-size: 1.1rem;
            margin-bottom: 30px;
            line-height: 1.6;
        }

        .cta-button {
            padding: 12px 24px;
            font-size: 1.2rem;
            border: none;
            border-radius: 50px;
            background-color: #ff5e62;
            color: white;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s, background-color 0.2s;
        }

        .cta-button:hover {
            transform: translateY(-2px);
            background-color: #ff4a4e;
        }

        /* „Çπ„Çø„É≥„Éó‰∏ÄË¶ßÁîªÈù¢ */
        #stamp-screen {
            display: none;
            padding: 20px;
            color: white;
            text-align: center;
            z-index: 8;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            overflow-y: auto;
        }

        #stamp-screen h2 {
            font-size: 2rem;
            margin-bottom: 20px;
        }

        .stamp-count {
            font-size: 1.2rem;
            margin-bottom: 20px;
            padding: 10px 20px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            display: inline-block;
        }

        .stamp-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 20px;
            justify-content: center;
            max-width: 700px;
            margin: 0 auto 30px;
        }

        .stamp-item {
            padding: 15px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            backdrop-filter: blur(5px);
            opacity: 0.5;
            transition: all 0.5s ease-in-out;
            cursor: pointer;
        }
        
        .stamp-item.collected {
            opacity: 1;
            box-shadow: 0 0 20px rgba(255, 255, 255, 0.5);
            animation: bounce 0.5s;
        }

        @keyframes bounce {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .stamp-item img {
            width: 100%;
            height: auto;
            border-radius: 10px;
            margin-bottom: 10px;
        }

        .stamp-item p {
            font-size: 0.9rem;
            font-weight: bold;
        }

        .stamp-item small {
            display: block;
            margin-top: 5px;
            font-size: 0.8rem;
            opacity: 0.8;
        }
        
        /* Êàª„Çã„Éú„Çø„É≥ */
        #back-button, #ar-back-button {
            position: fixed;
            top: 15px;
            left: 15px;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 1.5rem;
            display: none;
            cursor: pointer;
            z-index: 11;
            transition: background-color 0.2s;
        }
        
        #back-button:hover, #ar-back-button:hover {
            background-color: rgba(0, 0, 0, 0.7);
        }

        /* ARË°®Á§∫Áî® */
        #ar-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: none;
            z-index: 9;
        }

        #ar-scene {
            position: fixed !important;
            top: 0;
            left: 0;
            width: 100% !important;
            height: 100% !important;
            z-index: 100;
        }

        /* „Ç≥„É≥„Éó„É™„Éº„ÉàÁîªÈù¢ */
        .complete-message {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #333;
            padding: 30px 50px;
            border-radius: 20px;
            font-size: 1.8rem;
            font-weight: bold;
            z-index: 300;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            animation: completeAnimation 3s ease-in-out;
            text-align: center;
        }

        @keyframes completeAnimation {
            0% { 
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.5) rotate(-10deg);
            }
            50% { 
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.1) rotate(5deg);
            }
            100% { 
                opacity: 1;
                transform: translate(-50%, -50%) scale(1) rotate(0deg);
            }
        }
        
        /* „É≠„Ç∞„Ç≥„É≥„ÇΩ„Éº„É´ */
        #log-console {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            max-height: 150px;
            background-color: rgba(0, 0, 0, 0.7);
            color: #00ff00;
            font-family: 'Courier New', monospace;
            padding: 10px;
            overflow-y: scroll;
            display: none; /* „Éá„Éï„Ç©„É´„Éà„ÅßÈùûË°®Á§∫ */
            z-index: 10;
        }

        /* „É™„Çª„ÉÉ„Éà„Éú„Çø„É≥ */
        .reset-button {
            background-color: #666;
            font-size: 0.9rem;
            padding: 8px 16px;
            margin-top: 20px;
        }

        .reset-button:hover {
            background-color: #555;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- „Çπ„Çø„Éº„ÉàÁîªÈù¢ -->
        <div id="start-screen">
            <h1>ÊñáÂåñÁ•≠ AR„Çπ„Çø„É≥„Éó„É©„É™„Éº</h1>
            <p>
                8„Å§„ÅÆÂ†¥ÊâÄ„ÅßQR„Ç≥„Éº„Éâ„ÇíË¶ã„Å§„Åë„Å¶<br>
                „Çπ„Éû„Éõ„ÅÆ„Ç´„É°„É©„ÅßË™≠„ÅøÂèñ„Çç„ÅÜÔºÅ<br>
                ÂÖ®ÈÉ®ÈõÜ„ÇÅ„Çã„Å®Á¥†Êïµ„Å™„Åì„Å®„Åå...Ôºü
            </p>
            <button id="stamps-button" class="cta-button">„Çπ„Çø„É≥„Éó‰∏ÄË¶ß„ÇíË¶ã„Çã</button>
            <p style="margin-top: 20px; font-size: 0.9rem; opacity: 0.8;">
                QR„Ç≥„Éº„Éâ„ÅØ„Çπ„Éû„Éõ„ÅÆ„Ç´„É°„É©„Ç¢„Éó„É™„Åß<br>
                Ë™≠„ÅøÂèñ„Å£„Å¶„Åè„Å†„Åï„ÅÑ
            </p>
        </div>

        <!-- „Çπ„Çø„É≥„Éó‰∏ÄË¶ßÁîªÈù¢ -->
        <div id="stamp-screen">
            <h2>ÈõÜ„ÇÅ„Åü„Çπ„Çø„É≥„Éó</h2>
            <div class="stamp-count" id="stamp-count">0 / 8 ÂÄãÁç≤Âæó</div>
            <div class="stamp-grid" id="stamp-grid">
                <!-- JavaScript„Åß„Çπ„Çø„É≥„Éó„ÇíÁîüÊàê -->
            </div>
            <p>
                <button id="show-start-button" class="cta-button">„Éõ„Éº„É†„Å´Êàª„Çã</button>
                <br>
                <button id="reset-stamps-button" class="cta-button reset-button">„Çπ„Çø„É≥„Éó„Çí„É™„Çª„ÉÉ„Éà</button>
            </p>
        </div>

        <!-- ARË°®Á§∫ÁîªÈù¢ -->
        <div id="ar-screen">
            <!-- A-Frame„Ç∑„Éº„É≥„Ç≥„É≥„ÉÜ„Éä -->
        </div>
    </div>
    
    <!-- 2DÁîªÂÉè„ÇíË°®Á§∫„Åô„ÇãA-Frame„Ç∑„Éº„É≥ -->
    <a-scene id="ar-scene" embedded>
        <a-assets>
            <!-- „Éû„Çπ„Ç≥„ÉÉ„Éà„Ç≠„É£„É©„ÇØ„Çø„Éº„ÅÆÁîªÂÉè (nisyama1.png) -->
            <img id="mascot-image" src="./nisyama1.png" crossorigin="anonymous">
        </a-assets>

        <!-- 2DÁîªÂÉè„Çí„Ç´„É°„É©„ÅÆÂâç„Å´ÈÖçÁΩÆÔºà„Éì„É´„Éú„Éº„ÉâÂäπÊûú„ÅßÂ∏∏„Å´„Ç´„É°„É©„ÅÆÊñπ„ÇíÂêë„ÅèÔºâ -->
        <a-image 
            id="mascot-ar-image"
            src="#mascot-image" 
            position="0 0 -3" 
            scale="3 3 1" 
            look-at="[camera]"
            transparent="true"
            animation__position="property: position; from: 0 -1 -3; to: 0 0.5 -3; dur: 2000; easing: easeInOutSine; loop: true; dir: alternate"
            animation__rotation="property: rotation; from: 0 0 -10; to: 0 0 10; dur: 4000; easing: easeInOutSine; loop: true; dir: alternate"
            animation__scale="property: scale; from: 3 3 1; to: 3.5 3.5 1; dur: 1500; easing: easeInOutSine; loop: true; dir: alternate">
        </a-image>

        <!-- Á©∫„ÅÆËÉåÊôØËâ≤„ÇíË®≠ÂÆö -->
        <a-sky color="#667eea"></a-sky>

        <!-- A-Frame„ÅÆ„Éá„Éï„Ç©„É´„Éà„Ç´„É°„É©„Çí‰ΩøÁî® -->
        <a-camera></a-camera>
    </a-scene>
    
    <!-- Êàª„Çã„Éú„Çø„É≥ -->
    <button id="back-button" aria-label="Êàª„Çã" style="display: none;">&#8592;</button>
    <button id="ar-back-button" aria-label="Êàª„Çã" style="display: none;">&#8592;</button>
    
    <!-- „É≠„Ç∞„Ç≥„É≥„ÇΩ„Éº„É´ -->
    <pre id="log-console"></pre>

    <script>
        /**
         * „Éá„Éê„ÉÉ„Ç∞Áî®„É≠„Ç∞Âá∫ÂäõÈñ¢Êï∞
         * @param {string} message - „É≠„Ç∞„É°„ÉÉ„Çª„Éº„Ç∏
         */
        const logConsole = document.getElementById('log-console');
        function log(message) {
            console.log(message);
            const line = document.createElement('div');
            line.textContent = message;
            logConsole.appendChild(line);
            logConsole.scrollTop = logConsole.scrollHeight;
        }

        const app = {
            currentScreen: 'start',
            stamps: {
                entrance: { 
                    name: 'ÂÖ•Â†¥Âè£', 
                    collected: false, 
                    img: 'https://placehold.co/150x150/ffc0cb/000?text=ÂÖ•Â†¥Âè£',
                    description: '„Çà„ÅÜ„Åì„ÅùÊñáÂåñÁ•≠„Å∏ÔºÅ'
                },
                ticket: { 
                    name: 'ÈáëÂà∏Â£≤„ÇäÂ†¥', 
                    collected: false, 
                    img: 'https://placehold.co/150x150/98c1d9/000?text=ÈáëÂà∏',
                    description: 'ÈáëÂà∏„ÅØ„Åì„Å°„Çâ„Åß'
                },
                stage: { 
                    name: '„Çπ„ÉÜ„Éº„Ç∏Ââç', 
                    collected: false, 
                    img: 'https://placehold.co/150x150/f7e07a/000?text=„Çπ„ÉÜ„Éº„Ç∏',
                    description: '„Éë„Éï„Ç©„Éº„Éû„É≥„Çπ„ÇíÊ•Ω„Åó„ÇÇ„ÅÜ'
                },
                bunmi1: { 
                    name: 'ÊñáÂÆüÊ®°Êì¨Â∫óÔºë', 
                    collected: false, 
                    img: 'https://placehold.co/150x150/a9e2a9/000?text=ÊñáÂÆü1',
                    description: 'ÁæéÂë≥„Åó„ÅÑÈ£ü„ÅπÁâ©„Åå„ÅÑ„Å£„Å±„ÅÑ'
                },
                bunmi2: { 
                    name: 'ÊñáÂÆüÊ®°Êì¨Â∫óÔºí', 
                    collected: false, 
                    img: 'https://placehold.co/150x150/d2b4de/000?text=ÊñáÂÆü2',
                    description: 'Ê•Ω„Åó„ÅÑ„Ç≤„Éº„É†„Ç≥„Éº„Éä„Éº'
                },
                yamato: { 
                    name: 'Â∫≠Â§ßÂíå', 
                    collected: false, 
                    img: 'https://placehold.co/150x150/ffb6c1/000?text=Â∫≠Â§ßÂíå',
                    description: 'ÊÜ©„ÅÑ„ÅÆÁ©∫Èñì'
                },
                rhythm: { 
                    name: '„É™„Ç∫„É†È§®', 
                    collected: false, 
                    img: 'https://placehold.co/150x150/87ceeb/000?text=„É™„Ç∫„É†È§®',
                    description: 'Èü≥Ê•Ω„ÅÆ‰∏ñÁïå„Å∏'
                },
                gym: { 
                    name: '‰ΩìËÇ≤È§®', 
                    collected: false, 
                    img: 'https://placehold.co/150x150/dda0dd/000?text=‰ΩìËÇ≤È§®',
                    description: '„Çπ„Éù„Éº„ÉÑ„Ç§„Éô„É≥„ÉàÈñãÂÇ¨‰∏≠'
                }
            },
            
            log: log,

            /**
             * „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥„ÅÆÂàùÊúüÂåñ
             */
            init() {
                // URL„Éë„É©„É°„Éº„Çø„Çí„ÉÅ„Çß„ÉÉ„ÇØ
                this.checkUrlParams();
                
                this.loadStamps();
                this.setupEventListeners();
                this.renderStamps();
                this.updateStampCount();
                
                // „Çπ„Çø„É≥„Éó„Éë„É©„É°„Éº„Çø„Åå„ÅÇ„Çå„Å∞ARË°®Á§∫„ÄÅ„Å™„Åë„Çå„Å∞„Çπ„Çø„Éº„ÉàÁîªÈù¢
                const urlParams = new URLSearchParams(window.location.search);
                const stampParam = urlParams.get('stamp');
                
                if (stampParam && this.stamps[stampParam]) {
                    // Êñ∞„Åó„ÅÑ„Çπ„Çø„É≥„Éó„ÇíÁç≤Âæó
                    if (!this.stamps[stampParam].collected) {
                        this.collectStamp(stampParam);
                        log(`Êñ∞„Åó„ÅÑ„Çπ„Çø„É≥„Éó„ÇíÁç≤Âæó: ${stampParam} (${this.stamps[stampParam].name})`);
                    }
                    this.showScreen('ar');
                } else {
                    this.showScreen('start');
                }
                
                log('AR Stamp Rally initialized - QR„Ç≥„Éº„Éâ„ÅØÂ§ñÈÉ®„Ç´„É°„É©„Ç¢„Éó„É™„ÅßË™≠„ÅøÂèñ„Çä');
            },

            /**
             * URL„Éë„É©„É°„Éº„Çø„Çí„ÉÅ„Çß„ÉÉ„ÇØ„Åó„Å¶„Çπ„Çø„É≥„Éó„ÇíÂèéÈõÜ
             */
            checkUrlParams() {
                const urlParams = new URLSearchParams(window.location.search);
                const stampParam = urlParams.get('stamp');
                
                if (stampParam) {
                    log(`URL„Éë„É©„É°„Éº„ÇøÊ§úÂá∫: stamp=${stampParam}`);
                    
                    if (this.stamps[stampParam]) {
                        if (!this.stamps[stampParam].collected) {
                            // Êñ∞„Åó„ÅÑ„Çπ„Çø„É≥„Éó„ÇíÂèéÈõÜ
                            this.stamps[stampParam].collected = true;
                            log(`„Çπ„Çø„É≥„ÉóÁç≤Âæó: ${this.stamps[stampParam].name}`);
                        } else {
                            log(`Êó¢„Å´Áç≤ÂæóÊ∏à„Åø„ÅÆ„Çπ„Çø„É≥„Éó: ${this.stamps[stampParam].name}`);
                        }
                    } else {
                        log(`ÁÑ°Âäπ„Å™„Çπ„Çø„É≥„Éó„Éë„É©„É°„Éº„Çø: ${stampParam}`);
                    }
                }
            },

            /**
             * localStorage„Åã„Çâ„Çπ„Çø„É≥„Éó„Éá„Éº„Çø„Çí„É≠„Éº„Éâ
             */
            loadStamps() {
                try {
                    const savedStamps = localStorage.getItem('arStamps2024');
                    if (savedStamps) {
                        const parsedStamps = JSON.parse(savedStamps);
                        Object.keys(this.stamps).forEach(key => {
                            if (parsedStamps[key]) {
                                this.stamps[key].collected = parsedStamps[key].collected;
                            }
                        });
                        log('„Çπ„Çø„É≥„Éó„Éá„Éº„Çø„ÇíË™≠„ÅøËæº„Åø„Åæ„Åó„Åü');
                    }
                } catch (e) {
                    log('localStorageÂà©Áî®‰∏çÂèØ„ÄÅ„É°„É¢„É™ÂÜÖ„ÅßÁÆ°ÁêÜ„Åó„Åæ„Åô');
                }
            },

            /**
             * localStorage„Å´„Çπ„Çø„É≥„Éó„Éá„Éº„Çø„Çí‰øùÂ≠ò
             */
            saveStamps() {
                try {
                    localStorage.setItem('arStamps2024', JSON.stringify(this.stamps));
                    log('„Çπ„Çø„É≥„Éó„Éá„Éº„Çø„Çí‰øùÂ≠ò„Åó„Åæ„Åó„Åü');
                } catch (e) {
                    log('localStorageÂà©Áî®‰∏çÂèØ');
                }
            },

            /**
             * „Çπ„Çø„É≥„Éó„Çí„É™„Çª„ÉÉ„Éà
             */
            resetStamps() {
                if (confirm('Êú¨ÂΩì„Å´„Åô„Åπ„Å¶„ÅÆ„Çπ„Çø„É≥„Éó„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÅãÔºü')) {
                    Object.keys(this.stamps).forEach(key => {
                        this.stamps[key].collected = false;
                    });
                    this.saveStamps();
                    this.renderStamps();
                    this.updateStampCount();
                    log('„Åô„Åπ„Å¶„ÅÆ„Çπ„Çø„É≥„Éó„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åó„Åü');
                    
                    // URL„Éë„É©„É°„Éº„Çø„ÇíÂâäÈô§
                    const url = new URL(window.location);
                    url.searchParams.delete('stamp');
                    window.history.replaceState({}, document.title, url.pathname);
                }
            },

            /**
             * „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÅÆË®≠ÂÆö
             */
            setupEventListeners() {
                document.getElementById('stamps-button').addEventListener('click', () => this.showScreen('stamps'));
                document.getElementById('back-button').addEventListener('click', () => this.showScreen('start'));
                document.getElementById('ar-back-button').addEventListener('click', () => {
                    this.stopAR();
                    this.showScreen('stamps');
                });
                document.getElementById('show-start-button').addEventListener('click', () => this.showScreen('start'));
                document.getElementById('reset-stamps-button').addEventListener('click', () => this.resetStamps());
            },

            /**
             * ÁîªÈù¢Âàá„ÇäÊõø„Åà
             * @param {string} screenId - Âàá„ÇäÊõø„Åà„ÇãÁîªÈù¢ID ('start', 'stamps', 'ar')
             */
            showScreen(screenId) {
                this.currentScreen = screenId;
                
                const startScreen = document.getElementById('start-screen');
                const stampScreen = document.getElementById('stamp-screen');
                const arScreen = document.getElementById('ar-screen');
                const arScene = document.getElementById('ar-scene');
                const backButton = document.getElementById('back-button');
                const arBackButton = document.getElementById('ar-back-button');
                
                // ÂÖ®„Å¶„ÅÆÁîªÈù¢„ÇíÈùûË°®Á§∫„Å´
                startScreen.style.display = 'none';
                stampScreen.style.display = 'none';
                arScreen.style.display = 'none';
                arScene.style.display = 'none';
                backButton.style.display = 'none';
                arBackButton.style.display = 'none';

                if (screenId === 'start') {
                    startScreen.style.display = 'flex';
                    this.stopAR();
                    log('„Çπ„Çø„Éº„ÉàÁîªÈù¢„ÇíË°®Á§∫');
                } else if (screenId === 'stamps') {
                    stampScreen.style.display = 'block';
                    backButton.style.display = 'block';
                    this.renderStamps();
                    this.updateStampCount();
                    this.stopAR();
                    log('„Çπ„Çø„É≥„Éó‰∏ÄË¶ßÁîªÈù¢„ÇíË°®Á§∫');
                } else if (screenId === 'ar') {
                    arScreen.style.display = 'block';
                    arScene.style.display = 'block';
                    arBackButton.style.display = 'block';
                    
                    // AR„Ç∑„Éº„É≥„ÇíÂÜçÁîü
                    if (arScene.play && typeof arScene.play === 'function') {
                        arScene.play();
                    }
                    
                    // „Çπ„Çø„É≥„ÉóÁç≤Âæó„Ç®„Éï„Çß„ÇØ„Éà„ÇíË°®Á§∫
                    this.showStampEffect();
                    
                    log('ARÁîªÈù¢„ÇíË°®Á§∫ (nisyama1.png)');
                }
            },
            
            /**
             * AR„Ç∑„Éº„É≥„ÇíÂÅúÊ≠¢
             */
            stopAR() {
                const arScene = document.getElementById('ar-scene');
                if (arScene) {
                    try {
                        if (arScene.pause && typeof arScene.pause === 'function') {
                            arScene.pause();
                        }
                    } catch (e) {
                        log('AR scene pause not supported');
                    }
                    arScene.style.display = 'none';
                    
                    // AR„Ç§„É°„Éº„Ç∏„ÅÆ„Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„Çí„É™„Çª„ÉÉ„Éà
                    const mascotImage = document.getElementById('mascot-ar-image');
                    if (mascotImage) {
                        mascotImage.setAttribute('position', '0 0 -3');
                        mascotImage.setAttribute('scale', '3 3 1');
                        mascotImage.setAttribute('rotation', '0 0 0');
                    }
                    
                    log('AR„Ç∑„Éº„É≥„ÇíÂÅúÊ≠¢');
                }
            },

            /**
             * „Çπ„Çø„É≥„Éó„ÇíÂèéÈõÜ„Åó„ÄÅ„Éá„Éº„Çø„Çí‰øùÂ≠ò
             * @param {string} stampType - ÂèéÈõÜ„Åô„Çã„Çπ„Çø„É≥„Éó„ÅÆ„Çø„Ç§„Éó
             */
            collectStamp(stampType) {
                if (this.stamps[stampType]) {
                    this.stamps[stampType].collected = true;
                    this.saveStamps();
                    this.renderStamps();
                    this.updateStampCount();
                    
                    // ÂÖ®„Çπ„Çø„É≥„ÉóÁç≤Âæó„ÉÅ„Çß„ÉÉ„ÇØ
                    this.checkAllStampsCollected();
                }
            },

            /**
             * „Çπ„Çø„É≥„ÉóÁç≤ÂæóÊï∞„ÇíÊõ¥Êñ∞
             */
            updateStampCount() {
                const collectedCount = Object.values(this.stamps).filter(s => s.collected).length;
                const totalCount = Object.keys(this.stamps).length;
                const countElement = document.getElementById('stamp-count');
                if (countElement) {
                    countElement.textContent = `${collectedCount} / ${totalCount} ÂÄãÁç≤Âæó`;
                    
                    // ÂÖ®ÈÉ®ÈõÜ„ÇÅ„Åü„ÇâÁâπÂà•„Å™Ë°®Á§∫
                    if (collectedCount === totalCount) {
                        countElement.style.background = 'linear-gradient(135deg, #ffd700, #ffed4e)';
                        countElement.style.color = '#333';
                    }
                }
            },

            /**
             * ÂÖ®„Çπ„Çø„É≥„ÉóÂèéÈõÜ„Çí„ÉÅ„Çß„ÉÉ„ÇØ
             */
            checkAllStampsCollected() {
                const allCollected = Object.values(this.stamps).every(s => s.collected);
                if (allCollected) {
                    log('üéâ ÂÖ®„Çπ„Çø„É≥„Éó„Ç≥„É≥„Éó„É™„Éº„ÉàÔºÅ');
                    setTimeout(() => {
                        this.showCompleteMessage();
                    }, 2000);
                }
            },

            /**
             * „Ç≥„É≥„Éó„É™„Éº„Éà„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
             */
            showCompleteMessage() {
                const completeDiv = document.createElement('div');
                completeDiv.className = 'complete-message';
                completeDiv.innerHTML = `
                    <div>üéä „Ç≥„É≥„Éó„É™„Éº„ÉàÔºÅ üéä</div>
                    <div style="font-size: 1.2rem; margin-top: 10px;">
                        ÂÖ®„Çπ„Çø„É≥„ÉóÁç≤Âæó„Åä„ÇÅ„Åß„Å®„ÅÜÔºÅ
                    </div>
                    <div style="font-size: 1rem; margin-top: 10px;">
                        Á¥†Êô¥„Çâ„Åó„ÅÑÊé¢Ê§ú„Åß„Åó„ÅüÔºÅ
                    </div>
                `;
                document.body.appendChild(completeDiv);
                
                setTimeout(() => {
                    completeDiv.remove();
                }, 5000);
            },

            /**
             * „Çπ„Çø„É≥„ÉóÁç≤Âæó„Ç®„Éï„Çß„ÇØ„Éà„ÇíË°®Á§∫
             */
            showStampEffect() {
                const urlParams = new URLSearchParams(window.location.search);
                const stampParam = urlParams.get('stamp');
                let stampName = '„Çπ„Çø„É≥„Éó';
                
                if (stampParam && this.stamps[stampParam]) {
                    stampName = this.stamps[stampParam].name;
                }
                
                // „Çπ„Çø„É≥„ÉóÁç≤Âæó„É°„ÉÉ„Çª„Éº„Ç∏„ÇíË°®Á§∫
                const effectDiv = document.createElement('div');
                effectDiv.style.cssText = `
                    position: fixed;
                    top: 50%;
                    left: 50%;
                    transform: translate(-50%, -50%);
                    background: rgba(255, 255, 255, 0.95);
                    padding: 20px 40px;
                    border-radius: 20px;
                    font-size: 1.5rem;
                    font-weight: bold;
                    color: #ff5e62;
                    z-index: 200;
                    animation: stampGetEffect 2s ease-out;
                    pointer-events: none;
                    text-align: center;
                `;
                effectDiv.innerHTML = `
                    <div>${stampName}</div>
                    <div style="font-size: 1.8rem; margin-top: 10px;">„Çπ„Çø„É≥„ÉóGETÔºÅ</div>
                `;
                
                // „Ç¢„Éã„É°„Éº„Ç∑„Éß„É≥„ÅÆ„Çπ„Çø„Ç§„É´„ÇíËøΩÂä†
                if (!document.getElementById('stamp-effect-style')) {
                    const style = document.createElement('style');
                    style.id = 'stamp-effect-style';
                    style.textContent = `
                        @keyframes stampGetEffect {
                            0% { 
                                opacity: 0;
                                transform: translate(-50%, -50%) scale(0.5);
                            }
                            50% { 
                                opacity: 1;
                                transform: translate(-50%, -50%) scale(1.2);
                            }
                            100% { 
                                opacity: 0;
                                transform: translate(-50%, -50%) scale(1);
                            }
                        }
                    `;
                    document.head.appendChild(style);
                }
                
                document.body.appendChild(effectDiv);
                
                // 2ÁßíÂæå„Å´ÂâäÈô§„ÄÅ3ÁßíÂæå„Å´„Çπ„Çø„É≥„Éó‰∏ÄË¶ßÁîªÈù¢„Å´ÈÅ∑Áßª
                setTimeout(() => {
                    effectDiv.remove();
                    setTimeout(() => {
                        this.stopAR();
                        this.showScreen('stamps');
                    }, 1000);
                }, 2000);
            },

            /**
             * „Çπ„Çø„É≥„Éó„Ç∑„Éº„Éà„ÅÆË°®Á§∫„ÇíÊõ¥Êñ∞
             */
            renderStamps() {
                const stampGrid = document.getElementById('stamp-grid');
                if (!stampGrid) return;
                
                stampGrid.innerHTML = '';
                Object.keys(this.stamps).forEach(key => {
                    const stamp = this.stamps[key];
                    const item = document.createElement('div');
                    item.className = `stamp-item ${stamp.collected ? 'collected' : ''}`;
                    item.innerHTML = `
                        <img src="${stamp.img}" alt="${stamp.name}„Çπ„Çø„É≥„Éó">
                        <p>${stamp.name}</p>
                        <small>${stamp.collected ? stamp.description : 'Êú™Áç≤Âæó'}</small>
                    `;
                    
                    // Áç≤ÂæóÊ∏à„Åø„Çπ„Çø„É≥„Éó„Çí„ÇØ„É™„ÉÉ„ÇØ„Åô„Çã„Å®ARË°®Á§∫
                    if (stamp.collected) {
                        item.addEventListener('click', () => {
                            // URL„Éë„É©„É°„Éº„Çø„Çí‰∏ÄÊôÇÁöÑ„Å´Ë®≠ÂÆö
                            const url = new URL(window.location);
                            url.searchParams.set('stamp', key);
                            window.history.pushState({}, '', url);
                            this.showScreen('ar');
                        });
                    }
                    
                    stampGrid.appendChild(item);
                });
            }
        };
        
        // „Éö„Éº„Ç∏„É≠„Éº„ÉâÊôÇ„Å´„Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥„ÇíÂàùÊúüÂåñ
        window.onload = function() {
            app.init();
        };

        // „Éá„Éê„ÉÉ„Ç∞Áî®Ôºö„Ç≠„Éº„Éú„Éº„Éâ„Ç∑„Éß„Éº„Éà„Ç´„ÉÉ„ÉàÔºàÈñãÁô∫ÊôÇ„ÅÆ„ÅøÔºâ
        document.addEventListener('keydown', (e) => {
            // Êï∞Â≠ó„Ç≠„Éº1-8„Åß„Çπ„Çø„É≥„ÉóËøΩÂä†Ôºà„Éá„Éê„ÉÉ„Ç∞Áî®Ôºâ
            if (e.key >= '1' && e.key <= '8') {
                const stamps = ['entrance', 'ticket', 'stage', 'bunmi1', 'bunmi2', 'yamato', 'rhythm', 'gym'];
                const stampType = stamps[parseInt(e.key) - 1];
                if (stampType) {
                    // URL„Éë„É©„É°„Éº„Çø„ÇíË®≠ÂÆö
                    const url = new URL(window.location);
                    url.searchParams.set('stamp', stampType);
                    window.history.pushState({}, '', url);
                    
                    app.collectStamp(stampType);
                    app.showScreen('ar');
                    app.log(`Debug: „Çπ„Çø„É≥„ÉóËøΩÂä† ${stampType}`);
                }
            }
        });
    </script>
</body>
</html>