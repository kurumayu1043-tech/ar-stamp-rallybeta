<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¹ã‚¿ãƒ³ãƒ—åé›†ãƒ†ã‚¹ãƒˆãƒšãƒ¼ã‚¸</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            border-bottom: 3px solid #4CAF50;
            padding-bottom: 10px;
        }
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 16px;
        }
        button:hover {
            background: #45a049;
        }
        button.secondary {
            background: #ff9800;
        }
        button.danger {
            background: #f44336;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success {
            background: #d4edda;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
        }
        pre {
            background: #f4f4f4;
            padding: 10px;
            border-radius: 5px;
            overflow-x: auto;
        }
        .stamp-test-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin: 20px 0;
        }
        .stamp-test-item {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            text-align: center;
            cursor: pointer;
        }
        .stamp-test-item.collected {
            background: #d4edda;
            border-color: #28a745;
        }
        .stamp-test-item:hover {
            background: #f0f0f0;
        }
    </style>
</head>
<body>
    <h1>ğŸ” ã‚¹ã‚¿ãƒ³ãƒ—åé›†è¨ºæ–­ãƒ„ãƒ¼ãƒ«</h1>
    
    <div class="card">
        <h2>ğŸ“Š ç¾åœ¨ã®çŠ¶æ…‹</h2>
        <div id="current-status">
            <p>èª­ã¿è¾¼ã¿ä¸­...</p>
        </div>
    </div>
    
    <div class="card">
        <h2>ğŸ› ï¸ ãƒ†ã‚¹ãƒˆã‚¢ã‚¯ã‚·ãƒ§ãƒ³</h2>
        <button onclick="checkLocalStorage()">ğŸ’¾ LocalStorageç¢ºèª</button>
        <button onclick="testCollectStamp()">âœ… ãƒ†ã‚¹ãƒˆã‚¹ã‚¿ãƒ³ãƒ—åé›†</button>
        <button onclick="simulateTabSync()">ğŸ”„ ã‚¿ãƒ–åŒæœŸãƒ†ã‚¹ãƒˆ</button>
        <button onclick="clearAllData()" class="danger">ğŸ—‘ï¸ å…¨ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢</button>
        <button onclick="reloadPage()">ğŸ”„ ãƒšãƒ¼ã‚¸å†èª­ã¿è¾¼ã¿</button>
    </div>
    
    <div class="card">
        <h2>ğŸ¯ å€‹åˆ¥ã‚¹ã‚¿ãƒ³ãƒ—ãƒ†ã‚¹ãƒˆ</h2>
        <div class="stamp-test-grid" id="stamp-test-grid">
            <!-- å‹•çš„ã«ç”Ÿæˆ -->
        </div>
    </div>
    
    <div class="card">
        <h2>ğŸ“ ãƒ­ã‚°å‡ºåŠ›</h2>
        <pre id="log-output"></pre>
    </div>
    
    <script src="js/stamp-rally.js"></script>
    <script>
        let logBuffer = [];
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString('ja-JP');
            const logMessage = `[${timestamp}] ${message}`;
            logBuffer.push(logMessage);
            console.log(logMessage);
            
            const logOutput = document.getElementById('log-output');
            if (logOutput) {
                logOutput.textContent = logBuffer.slice(-20).join('\n');
            }
        }
        
        function updateStatus() {
            const statusDiv = document.getElementById('current-status');
            
            // stampRallyã®çŠ¶æ…‹ã‚’ç¢ºèª
            if (typeof stampRally === 'undefined') {
                statusDiv.innerHTML = '<div class="status error">âŒ stampRally ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';
                return;
            }
            
            // LocalStorageã‹ã‚‰ç›´æ¥èª­ã¿è¾¼ã¿
            const localStorageData = localStorage.getItem('arStamps2024');
            const parsedData = localStorageData ? JSON.parse(localStorageData) : {};
            
            // stampRallyã®çŠ¶æ…‹ã‚’å†èª­ã¿è¾¼ã¿
            stampRally.loadStamps();
            
            let html = '';
            html += '<div class="status info">âœ… stampRally ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆæ¤œå‡º</div>';
            html += `<div class="status info">åé›†æ¸ˆã¿ã‚¹ã‚¿ãƒ³ãƒ—æ•°: ${stampRally.getCollectedCount()} / ${Object.keys(STAMP_DATA).length}</div>`;
            
            // LocalStorageã®å†…å®¹
            html += '<h3>LocalStorageå†…å®¹:</h3>';
            html += '<pre>' + JSON.stringify(parsedData, null, 2) + '</pre>';
            
            // stampRallyã®å†…å®¹
            html += '<h3>stampRally.stampså†…å®¹:</h3>';
            html += '<pre>' + JSON.stringify(stampRally.stamps, null, 2) + '</pre>';
            
            // å„ã‚¹ã‚¿ãƒ³ãƒ—ã®çŠ¶æ…‹
            html += '<h3>å„ã‚¹ã‚¿ãƒ³ãƒ—ã®çŠ¶æ…‹:</h3>';
            Object.keys(STAMP_DATA).forEach(stampId => {
                const isCollected = stampRally.isCollected(stampId);
                const status = isCollected ? 'âœ… åé›†æ¸ˆã¿' : 'âŒ æœªåé›†';
                html += `<div>${STAMP_DATA[stampId].name}: ${status}</div>`;
            });
            
            statusDiv.innerHTML = html;
        }
        
        function checkLocalStorage() {
            log('LocalStorageç¢ºèªé–‹å§‹');
            
            const data = localStorage.getItem('arStamps2024');
            if (data) {
                log('LocalStorageãƒ‡ãƒ¼ã‚¿ç™ºè¦‹: ' + data);
                try {
                    const parsed = JSON.parse(data);
                    log('ãƒ‘ãƒ¼ã‚¹æˆåŠŸã€‚ã‚¹ã‚¿ãƒ³ãƒ—æ•°: ' + Object.keys(parsed).length);
                } catch (e) {
                    log('ãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼: ' + e.message, 'error');
                }
            } else {
                log('LocalStorageã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', 'warning');
            }
            
            updateStatus();
        }
        
        function testCollectStamp() {
            log('ãƒ†ã‚¹ãƒˆã‚¹ã‚¿ãƒ³ãƒ—åé›†é–‹å§‹');
            
            // entranceã‚¹ã‚¿ãƒ³ãƒ—ã‚’åé›†
            const isNew = stampRally.collectStamp('entrance');
            log(`entranceåé›†çµæœ: ${isNew ? 'æ–°è¦å–å¾—' : 'æ—¢ã«å–å¾—æ¸ˆã¿'}`);
            
            // LocalStorageã‚’ç¢ºèª
            const data = localStorage.getItem('arStamps2024');
            log('åé›†å¾Œã®LocalStorage: ' + data);
            
            updateStatus();
            renderStampGrid();
        }
        
        function simulateTabSync() {
            log('ã‚¿ãƒ–åŒæœŸã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹');
            
            // storage eventã‚’æ‰‹å‹•ã§ç™ºç«
            const event = new StorageEvent('storage', {
                key: 'arStamps2024',
                newValue: localStorage.getItem('arStamps2024'),
                oldValue: null,
                storageArea: localStorage,
                url: window.location.href
            });
            
            window.dispatchEvent(event);
            log('storage eventã‚’ç™ºç«ã—ã¾ã—ãŸ');
            
            // stampRallyã®å†èª­ã¿è¾¼ã¿
            stampRally.loadStamps();
            log('stampRallyã‚’å†èª­ã¿è¾¼ã¿ã—ã¾ã—ãŸ');
            
            updateStatus();
            renderStampGrid();
        }
        
        function clearAllData() {
            if (confirm('æœ¬å½“ã«å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) {
                log('å…¨ãƒ‡ãƒ¼ã‚¿ã‚¯ãƒªã‚¢å®Ÿè¡Œ');
                localStorage.removeItem('arStamps2024');
                localStorage.removeItem('arStamps2024_tabs');
                sessionStorage.clear();
                stampRally.stamps = {};
                log('ã‚¯ãƒªã‚¢å®Œäº†');
                updateStatus();
                renderStampGrid();
            }
        }
        
        function reloadPage() {
            window.location.reload();
        }
        
        function collectIndividualStamp(stampId) {
            log(`å€‹åˆ¥ã‚¹ã‚¿ãƒ³ãƒ—åé›†: ${stampId}`);
            const isNew = stampRally.collectStamp(stampId);
            log(`${stampId}åé›†çµæœ: ${isNew ? 'æ–°è¦å–å¾—' : 'æ—¢ã«å–å¾—æ¸ˆã¿'}`);
            updateStatus();
            renderStampGrid();
        }
        
        function renderStampGrid() {
            const grid = document.getElementById('stamp-test-grid');
            grid.innerHTML = '';
            
            Object.keys(STAMP_DATA).forEach(stampId => {
                const stamp = STAMP_DATA[stampId];
                const isCollected = stampRally.isCollected(stampId);
                
                const item = document.createElement('div');
                item.className = `stamp-test-item ${isCollected ? 'collected' : ''}`;
                item.onclick = () => collectIndividualStamp(stampId);
                item.innerHTML = `
                    <div>${stamp.icon}</div>
                    <div><strong>${stamp.name}</strong></div>
                    <div>${isCollected ? 'âœ… åé›†æ¸ˆã¿' : 'âŒ æœªåé›†'}</div>
                `;
                
                grid.appendChild(item);
            });
        }
        
        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
        document.addEventListener('DOMContentLoaded', () => {
            log('ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†');
            
            if (typeof stampRally === 'undefined') {
                log('stampRallyãŒå®šç¾©ã•ã‚Œã¦ã„ã¾ã›ã‚“ï¼', 'error');
                return;
            }
            
            log('stampRallyåˆæœŸåŒ–æˆåŠŸ');
            updateStatus();
            renderStampGrid();
            
            // storageã‚¤ãƒ™ãƒ³ãƒˆã®ãƒªã‚¹ãƒŠãƒ¼
            window.addEventListener('storage', (e) => {
                if (e.key === 'arStamps2024') {
                    log('storage eventæ¤œå‡º: arStamps2024ãŒå¤‰æ›´ã•ã‚Œã¾ã—ãŸ');
                    updateStatus();
                    renderStampGrid();
                }
            });
            
            // visibilitychangeã‚¤ãƒ™ãƒ³ãƒˆã®ãƒªã‚¹ãƒŠãƒ¼
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden) {
                    log('ã‚¿ãƒ–ãŒã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ãªã‚Šã¾ã—ãŸ');
                    stampRally.loadStamps();
                    updateStatus();
                    renderStampGrid();
                }
            });
        });
    </script>
</body>
</html>